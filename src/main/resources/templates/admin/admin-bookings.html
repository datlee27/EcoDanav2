<!-- Bookings Tab Content -->
<div th:fragment="bookings-tab">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-6">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-calendar-check text-3xl text-blue-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Bookings</dt>
                            <dd class="text-2xl font-semibold text-gray-900" id="dashboardTotalBookings">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-3xl text-yellow-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                            <dd class="text-2xl font-semibold text-gray-900" id="dashboardPendingBookings">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-3xl text-green-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Approved</dt>
                            <dd class="text-2xl font-semibold text-gray-900" id="dashboardApprovedBookings">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-car text-3xl text-purple-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Ongoing</dt>
                            <dd class="text-2xl font-semibold text-gray-900" id="dashboardOngoingBookings">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Table -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Booking Management</h3>
                <div class="flex space-x-2">
                    <select id="dashboardStatusFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <input type="text" id="dashboardSearchInput" placeholder="Search bookings..." class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="dashboardBookingsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">Loading bookings...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Inline JavaScript for Dashboard Bookings -->
    <script th:inline="javascript">
    (function() {
        'use strict';
        
        console.log('Dashboard bookings script loaded');
        
        var bookingsData = [];
        var filteredData = [];
        
        function loadDashboardBookings() {
            console.log('Loading dashboard bookings...');
            fetch('/admin/api/bookings')
                .then(function(response) {
                    console.log('Response status:', response.status);
                    if (!response.ok) throw new Error('Failed to load bookings');
                    return response.json();
                })
                .then(function(data) {
                    console.log('Received bookings:', data);
                    bookingsData = data || [];
                    filteredData = bookingsData;
                    renderDashboardBookings();
                    updateDashboardStatistics();
                })
                .catch(function(error) {
                    console.error('Error loading bookings:', error);
                    showDashboardError();
                });
        }
        
        function renderDashboardBookings() {
            var tbody = document.getElementById('dashboardBookingsTableBody');
            if (!tbody) {
                console.error('Table body not found!');
                return;
            }
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No bookings found</td></tr>';
                return;
            }
            
            var html = '';
            filteredData.forEach(function(booking) {
                html += createDashboardBookingRow(booking);
            });
            tbody.innerHTML = html;
        }
        
        function createDashboardBookingRow(booking) {
            var statusClass = getStatusClass(booking.status);
            var html = '<tr class="hover:bg-gray-50">';
            html += '<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">' + escapeHtml(booking.bookingCode || '-') + '</div></td>';
            html += '<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">' + escapeHtml(booking.userName || '-') + '</div><div class="text-xs text-gray-500">' + escapeHtml(booking.userEmail || '-') + '</div></td>';
            html += '<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">' + escapeHtml(booking.vehicleModel || '-') + '</div><div class="text-xs text-gray-500">' + escapeHtml(booking.licensePlate || '-') + '</div></td>';
            html += '<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">' + formatDateTime(booking.pickupDateTime) + '</div><div class="text-xs text-gray-500">' + formatDateTime(booking.returnDateTime) + '</div></td>';
            html += '<td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' + statusClass + '">' + escapeHtml(booking.status) + '</span></td>';
            html += '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">' + formatCurrency(booking.totalAmount) + '</td>';
            html += '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">';
            html += '<button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="viewBookingDetail(\'' + booking.bookingId + '\')">View</button>';
            if (booking.status === 'Pending') {
                html += '<button class="text-green-600 hover:text-green-900 mr-3" onclick="updateBookingStatus(\'' + booking.bookingId + '\', \'Approved\')">Approve</button>';
                html += '<button class="text-red-600 hover:text-red-900" onclick="updateBookingStatus(\'' + booking.bookingId + '\', \'Rejected\')">Reject</button>';
            } else if (booking.status === 'Approved') {
                html += '<button class="text-blue-600 hover:text-blue-900" onclick="updateBookingStatus(\'' + booking.bookingId + '\', \'Completed\')">Complete</button>';
            }
            html += '</td>';
            html += '</tr>';
            return html;
        }
        
        function updateDashboardStatistics() {
            var total = bookingsData.length;
            var pending = bookingsData.filter(function(b) { return b.status === 'Pending'; }).length;
            var approved = bookingsData.filter(function(b) { return b.status === 'Approved'; }).length;
            var ongoing = bookingsData.filter(function(b) { return b.status === 'Ongoing'; }).length;
            
            var totalEl = document.getElementById('dashboardTotalBookings');
            var pendingEl = document.getElementById('dashboardPendingBookings');
            var approvedEl = document.getElementById('dashboardApprovedBookings');
            var ongoingEl = document.getElementById('dashboardOngoingBookings');
            
            if (totalEl) totalEl.textContent = total;
            if (pendingEl) pendingEl.textContent = pending;
            if (approvedEl) approvedEl.textContent = approved;
            if (ongoingEl) ongoingEl.textContent = ongoing;
        }
        
        function getStatusClass(status) {
            var classes = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'Approved': 'bg-green-100 text-green-800',
                'Rejected': 'bg-red-100 text-red-800',
                'Ongoing': 'bg-blue-100 text-blue-800',
                'Completed': 'bg-purple-100 text-purple-800',
                'Cancelled': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            var date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatCurrency(amount) {
            if (!amount) return '0 ₫';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function showDashboardError() {
            var tbody = document.getElementById('dashboardBookingsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-red-500">Error loading bookings. Please try again.</td></tr>';
            }
        }
        
        // Event listeners
        var statusFilter = document.getElementById('dashboardStatusFilter');
        var searchInput = document.getElementById('dashboardSearchInput');
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                var status = this.value;
                filteredData = status ? bookingsData.filter(function(b) { return b.status === status; }) : bookingsData;
                renderDashboardBookings();
            });
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                var search = this.value.toLowerCase();
                filteredData = bookingsData.filter(function(b) {
                    return (b.bookingCode && b.bookingCode.toLowerCase().includes(search)) ||
                           (b.userName && b.userName.toLowerCase().includes(search)) ||
                           (b.userEmail && b.userEmail.toLowerCase().includes(search)) ||
                           (b.vehicleModel && b.vehicleModel.toLowerCase().includes(search)) ||
                           (b.licensePlate && b.licensePlate.toLowerCase().includes(search));
                });
                renderDashboardBookings();
            });
        }
        
        // Load bookings when tab is shown
        loadDashboardBookings();
        
        // Reload when switching back to bookings tab
        window.addEventListener('tabChanged', function(e) {
            if (e.detail === 'bookings') {
                console.log('Bookings tab activated, reloading...');
                loadDashboardBookings();
            }
        });
        
        // Global functions for buttons
        window.viewBookingDetail = function(bookingId) {
            console.log('Viewing booking:', bookingId);
            fetch('/admin/api/bookings/' + bookingId)
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to load booking details');
                    return response.json();
                })
                .then(function(booking) {
                    showBookingDetailModal(booking);
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert('Failed to load booking details');
                });
        };
        
        window.updateBookingStatus = function(bookingId, newStatus) {
            var reason = '';
            if (newStatus === 'Rejected' || newStatus === 'Cancelled') {
                reason = prompt('Please enter reason for ' + newStatus.toLowerCase() + ':');
                if (!reason) return;
            }
            
            if (!confirm('Are you sure you want to change status to ' + newStatus + '?')) return;
            
            fetch('/admin/api/bookings/' + bookingId + '/status', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: newStatus, reason: reason})
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to update status');
                return response.json();
            })
            .then(function(result) {
                if (result.success) {
                    // Show success message
                    showSuccessNotification('Booking status updated to ' + newStatus);
                    
                    // Reload bookings data
                    loadDashboardBookings();
                    
                    // Auto-switch filter to show the new status
                    if (newStatus === 'Approved' || newStatus === 'Rejected') {
                        setTimeout(function() {
                            var statusFilter = document.getElementById('dashboardStatusFilter');
                            if (statusFilter) {
                                statusFilter.value = newStatus;
                                statusFilter.dispatchEvent(new Event('change'));
                            }
                        }, 500);
                    }
                } else {
                    throw new Error(result.message || 'Update failed');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Failed to update booking status: ' + error.message);
            });
        };
        
        function showBookingDetailModal(booking) {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'bookingDetailModal';
            
            var content = '<div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">';
            content += '<div class="flex justify-between items-center mb-4">';
            content += '<h3 class="text-xl font-bold text-gray-900">Booking Details</h3>';
            content += '<button onclick="closeBookingDetailModal()" class="text-gray-400 hover:text-gray-600">';
            content += '<i class="fas fa-times text-2xl"></i></button></div>';
            
            content += '<div class="grid grid-cols-2 gap-4">';
            content += createDetailItem('Booking Code', booking.bookingCode);
            content += createDetailItem('Status', '<span class="px-2 py-1 rounded-full text-xs font-semibold ' + getStatusClass(booking.status) + '">' + booking.status + '</span>');
            content += createDetailItem('Customer', booking.userName || '-');
            content += createDetailItem('Email', booking.userEmail || '-');
            content += createDetailItem('Phone', booking.userPhone || '-');
            content += createDetailItem('Vehicle', booking.vehicleModel || '-');
            content += createDetailItem('License Plate', booking.licensePlate || '-');
            content += createDetailItem('Rental Type', booking.rentalType || '-');
            content += createDetailItem('Pickup Date', formatDateTime(booking.pickupDateTime));
            content += createDetailItem('Return Date', formatDateTime(booking.returnDateTime));
            content += createDetailItem('Total Amount', formatCurrency(booking.totalAmount));
            content += createDetailItem('Payment Method', booking.expectedPaymentMethod || '-');
            content += createDetailItem('Created Date', formatDateTime(booking.createdDate));
            
            if (booking.handledByName) {
                content += createDetailItem('Handled By', booking.handledByName);
            }
            if (booking.cancelReason) {
                content += '<div class="col-span-2">' + createDetailItem('Cancel Reason', booking.cancelReason) + '</div>';
            }
            content += '</div>';
            
            content += '<div class="mt-6 flex justify-end space-x-3">';
            content += '<button onclick="closeBookingDetailModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Close</button>';
            content += '</div></div>';
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }
        
        window.closeBookingDetailModal = function() {
            var modal = document.getElementById('bookingDetailModal');
            if (modal) modal.remove();
        };
        
        function createDetailItem(label, value) {
            return '<div class="p-3 bg-gray-50 rounded"><div class="text-xs font-semibold text-gray-500 uppercase mb-1">' + 
                   escapeHtml(label) + '</div><div class="text-sm text-gray-900 font-medium">' + value + '</div></div>';
        }
        
        // Show success notification
        function showSuccessNotification(message) {
            // Create notification element
            var notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-slide-in';
            notification.innerHTML = '<i class="fas fa-check-circle"></i><span>' + message + '</span>';
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(function() {
                    notification.remove();
                }, 500);
            }, 3000);
        }
    })();
    </script>
</div>
