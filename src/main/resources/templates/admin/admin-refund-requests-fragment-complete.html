<!-- Refund Requests Tab Content - Server-Side Rendered -->
<div th:fragment="refund-requests-tab">
    <div class="bg-white shadow rounded-lg">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 p-6 border-b border-gray-200">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Requests</p>
                        <p class="text-2xl font-bold text-blue-600" th:text="${totalCount ?: 0}">0</p>
                    </div>
                    <i class="fas fa-list text-3xl text-blue-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Pending</p>
                        <p class="text-2xl font-bold text-yellow-600" th:text="${pendingCount ?: 0}">0</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-yellow-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Approved</p>
                        <p class="text-2xl font-bold text-green-600" th:text="${approvedCount ?: 0}">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Rejected</p>
                        <p class="text-2xl font-bold text-red-600" th:text="${rejectedCount ?: 0}">0</p>
                    </div>
                    <i class="fas fa-times-circle text-3xl text-red-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Urgent (< 2h)</p>
                        <p class="text-2xl font-bold text-orange-600" th:text="${urgentCount ?: 0}">0</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-3xl text-orange-200"></i>
                </div>
            </div>
        </div>

        <!-- Total Pending Amount -->
        <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-700">Total Pending Refund Amount</p>
                    <p class="text-3xl font-bold text-red-600" th:text="${#numbers.formatDecimal(totalPendingAmount ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</p>
                </div>
                <i class="fas fa-money-bill-wave text-5xl text-red-200"></i>
            </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Refund Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Urgency</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr th:each="refund : ${refundRequests}" class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900" th:text="${#strings.abbreviate(refund.refundRequestId, 8)}">ID</td>
                        <td class="px-6 py-4 text-sm text-gray-900" th:text="${refund.booking?.bookingCode}">-</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <span th:if="${refund.user}" th:text="${refund.user.firstName + ' ' + refund.user.lastName}">-</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900" th:text="${refund.user?.phoneNumber}">-</td>
                        <td class="px-6 py-4 text-sm font-medium text-red-600" th:text="${#numbers.formatDecimal(refund.refundAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</td>
                        <td class="px-6 py-4 text-sm">
                            <span th:if="${refund.status.toString() == 'Pending'}" class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock mr-1"></i>Chờ duyệt
                            </span>
                            <span th:if="${refund.status.toString() == 'Approved'}" class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Đã duyệt
                            </span>
                            <span th:if="${refund.status.toString() == 'Rejected'}" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                <i class="fas fa-times mr-1"></i>Từ chối
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span th:if="${refund.isWithinTwoHours}" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                <i class="fas fa-exclamation-circle mr-1"></i>Khẩn cấp
                            </span>
                            <span th:unless="${refund.isWithinTwoHours}" class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                                Bình thường
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900" th:text="${#temporals.format(refund.createdDate, 'dd/MM/yyyy HH:mm')}">-</td>
                        <td class="px-6 py-4 text-sm">
                            <button type="button" 
                                    onclick="showRefundDetailModal(this)"
                                    th:data-refund-id="${refund.refundRequestId}"
                                    th:data-refund-amount="${refund.refundAmount}"
                                    th:data-booking-code="${refund.booking?.bookingCode}"
                                    th:data-customer-name="${refund.user?.firstName} ${refund.user?.lastName}"
                                    th:data-customer-email="${refund.user?.email}"
                                    th:data-customer-phone="${refund.user?.phoneNumber}"
                                    th:data-status="${refund.status}"
                                    th:data-cancel-reason="${refund.cancelReason}"
                                    th:data-admin-notes="${refund.adminNotes}"
                                    th:data-created-date="${#temporals.format(refund.createdDate, 'dd/MM/yyyy HH:mm')}"
                                    th:data-is-urgent="${refund.isWithinTwoHours}"
                                    th:data-bank-name="${refund.bankAccount?.bankName}"
                                    th:data-account-number="${refund.bankAccount?.accountNumber}"
                                    th:data-account-holder="${refund.bankAccount?.accountHolderName}"
                                    class="text-blue-600 hover:text-blue-800" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(refundRequests)}">
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 block text-gray-300"></i>
                            Không có yêu cầu hoàn tiền nào
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div id="refundDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-600 to-red-600 p-6 text-white sticky top-0">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-bold">Chi tiết yêu cầu hoàn tiền</h3>
                    <p class="text-orange-100 text-sm mt-1" id="modalRefundId">ID: -</p>
                </div>
                <button onclick="closeRefundDetailModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6 space-y-4">
            <!-- Status Badge -->
            <div id="statusBadge" class="px-4 py-2 rounded-full text-sm font-semibold inline-block">-</div>

            <!-- Refund Amount -->
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="text-sm text-gray-600">Số tiền hoàn</p>
                <p class="text-3xl font-bold text-red-600" id="modalRefundAmount">0 ₫</p>
            </div>

            <!-- Booking & Customer Info -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                    <p class="text-sm text-gray-600">Mã booking</p>
                    <p class="text-lg font-semibold text-gray-900" id="modalBookingCode">-</p>
                </div>
                <div class="bg-blue-50 p-4 rounded">
                    <p class="text-sm text-gray-600">Ngày yêu cầu</p>
                    <p class="text-lg font-semibold text-gray-900" id="modalCreatedDate">-</p>
                </div>
            </div>

            <!-- Customer Info -->
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Thông tin khách hàng</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded">
                        <p class="text-sm text-gray-600">Tên</p>
                        <p class="text-lg font-semibold text-gray-900" id="modalCustomerName">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded">
                        <p class="text-sm text-gray-600">Email</p>
                        <p class="text-lg font-semibold text-gray-900" id="modalCustomerEmail">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded col-span-2">
                        <p class="text-sm text-gray-600">Số điện thoại</p>
                        <p class="text-lg font-semibold text-gray-900" id="modalCustomerPhone">-</p>
                    </div>
                </div>
            </div>

            <!-- Bank Account Info -->
            <div id="bankAccountSection" class="hidden">
                <h4 class="font-semibold text-gray-900 mb-3">Thông tin tài khoản ngân hàng</h4>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Ngân hàng</p>
                            <p class="text-lg font-semibold text-gray-900" id="modalBankName">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Số tài khoản</p>
                            <p class="text-lg font-semibold text-gray-900" id="modalAccountNumber">-</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">Chủ tài khoản</p>
                            <p class="text-lg font-semibold text-gray-900" id="modalAccountHolder">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancel Reason -->
            <div>
                <h4 class="font-semibold text-gray-900 mb-3">Lý do hủy</h4>
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                    <p class="text-gray-900" id="modalCancelReason">-</p>
                </div>
            </div>

            <!-- Admin Notes -->
            <div id="adminNotesSection" class="hidden">
                <h4 class="font-semibold text-gray-900 mb-3">Ghi chú từ admin</h4>
                <div class="bg-gray-50 border-l-4 border-gray-500 p-4 rounded">
                    <p class="text-gray-900" id="modalAdminNotes">-</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 bg-gray-50 border-t flex justify-end gap-3">
            <button onclick="closeRefundDetailModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                <i class="fas fa-times mr-2"></i>Đóng
            </button>
        </div>
    </div>
</div>

<script>
function showRefundDetailModal(button) {
    const data = {
        refundId: button.getAttribute('data-refund-id'),
        refundAmount: button.getAttribute('data-refund-amount'),
        bookingCode: button.getAttribute('data-booking-code'),
        customerName: button.getAttribute('data-customer-name'),
        customerEmail: button.getAttribute('data-customer-email'),
        customerPhone: button.getAttribute('data-customer-phone'),
        status: button.getAttribute('data-status'),
        cancelReason: button.getAttribute('data-cancel-reason'),
        adminNotes: button.getAttribute('data-admin-notes'),
        createdDate: button.getAttribute('data-created-date'),
        isUrgent: button.getAttribute('data-is-urgent'),
        bankName: button.getAttribute('data-bank-name'),
        accountNumber: button.getAttribute('data-account-number'),
        accountHolder: button.getAttribute('data-account-holder')
    };

    // Set values
    document.getElementById('modalRefundId').textContent = 'ID: ' + data.refundId.substring(0, 8) + '...';
    document.getElementById('modalRefundAmount').textContent = new Intl.NumberFormat('vi-VN').format(data.refundAmount) + ' ₫';
    document.getElementById('modalBookingCode').textContent = data.bookingCode || '-';
    document.getElementById('modalCreatedDate').textContent = data.createdDate || '-';
    document.getElementById('modalCustomerName').textContent = data.customerName || '-';
    document.getElementById('modalCustomerEmail').textContent = data.customerEmail || '-';
    document.getElementById('modalCustomerPhone').textContent = data.customerPhone || '-';
    document.getElementById('modalCancelReason').textContent = data.cancelReason || '-';

    // Status badge
    const statusBadge = document.getElementById('statusBadge');
    if (data.status === 'Pending') {
        statusBadge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800 inline-block';
        statusBadge.innerHTML = '<i class="fas fa-clock mr-1"></i>Chờ duyệt';
    } else if (data.status === 'Approved') {
        statusBadge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800 inline-block';
        statusBadge.innerHTML = '<i class="fas fa-check mr-1"></i>Đã duyệt';
    } else if (data.status === 'Rejected') {
        statusBadge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800 inline-block';
        statusBadge.innerHTML = '<i class="fas fa-times mr-1"></i>Từ chối';
    }

    // Bank account section
    if (data.bankName && data.bankName !== 'null') {
        document.getElementById('bankAccountSection').classList.remove('hidden');
        document.getElementById('modalBankName').textContent = data.bankName || '-';
        document.getElementById('modalAccountNumber').textContent = data.accountNumber || '-';
        document.getElementById('modalAccountHolder').textContent = data.accountHolder || '-';
    } else {
        document.getElementById('bankAccountSection').classList.add('hidden');
    }

    // Admin notes section
    if (data.adminNotes && data.adminNotes !== 'null') {
        document.getElementById('adminNotesSection').classList.remove('hidden');
        document.getElementById('modalAdminNotes').textContent = data.adminNotes || '-';
    } else {
        document.getElementById('adminNotesSection').classList.add('hidden');
    }

    // Show modal
    document.getElementById('refundDetailModal').classList.remove('hidden');
}

function closeRefundDetailModal() {
    document.getElementById('refundDetailModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('refundDetailModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeRefundDetailModal();
    }
});
</script>
