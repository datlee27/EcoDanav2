<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh Sửa Xe - EcoDana Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-green-700 to-green-900 text-white fixed h-full">
            <div class="p-6">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-leaf mr-2"></i>
                    EcoDana Admin
                </h1>
            </div>
            <nav class="mt-6">
                <a href="/admin/dashboard" class="flex items-center px-6 py-3 hover:bg-green-600 transition">
                    <i class="fas fa-home mr-3"></i>
                    Dashboard
                </a>
                <a href="/admin?tab=vehicles" class="flex items-center px-6 py-3 bg-green-600 border-l-4 border-white">
                    <i class="fas fa-car mr-3"></i>
                    Quản Lý Xe
                </a>
                <a href="/admin/bookings" class="flex items-center px-6 py-3 hover:bg-green-600 transition">
                    <i class="fas fa-calendar-check mr-3"></i>
                    Đặt Xe
                </a>
                <a href="/admin/users" class="flex items-center px-6 py-3 hover:bg-green-600 transition">
                    <i class="fas fa-users mr-3"></i>
                    Người Dùng
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <a href="/admin?tab=vehicles" class="text-green-600 hover:text-green-700 mb-2 inline-block">
                        <i class="fas fa-arrow-left mr-2"></i>Quay Lại
                    </a>
                    <h2 class="text-3xl font-bold text-gray-800">Chỉnh Sửa Xe</h2>
                    <p class="text-gray-600 mt-1">Cập nhật thông tin xe trong hệ thống</p>
                </div>
            </div>

            <!-- Form -->
            <form id="vehicleForm" class="bg-white rounded-lg shadow-md p-8">
                <input type="hidden" name="vehicleId" th:value="${vehicle.vehicleId}">
                
                <!-- Basic Information -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle text-green-600 mr-2"></i>
                        Thông Tin Cơ Bản
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên Xe <span class="text-red-500">*</span></label>
                            <input type="text" name="vehicleModel" required th:value="${vehicle.vehicleModel}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Biển Số <span class="text-red-500">*</span></label>
                            <input type="text" name="licensePlate" required th:value="${vehicle.licensePlate}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại Xe <span class="text-red-500">*</span></label>
                            <select name="vehicleType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="ElectricCar" th:selected="${vehicle.vehicleType == 'ElectricCar'}">Xe Ô Tô Điện</option>
                                <option value="ElectricMotorcycle" th:selected="${vehicle.vehicleType == 'ElectricMotorcycle'}">Xe Máy Điện</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Năm Sản Xuất <span class="text-red-500">*</span></label>
                            <input type="number" name="yearManufactured" required min="2000" max="2025" th:value="${vehicle.yearManufactured}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số Chỗ Ngồi <span class="text-red-500">*</span></label>
                            <input type="number" name="seats" required min="1" max="50" th:value="${vehicle.seats}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số Km Đã Đi <span class="text-red-500">*</span></label>
                            <input type="number" name="odometer" required min="0" th:value="${vehicle.odometer}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dung Lượng Pin (kWh)</label>
                            <input type="number" name="batteryCapacity" step="0.01" min="0" th:value="${vehicle.batteryCapacity}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Trạng Thái <span class="text-red-500">*</span></label>
                            <select name="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="Available" th:selected="${vehicle.status == 'Available'}">Sẵn Sàng</option>
                                <option value="Rented" th:selected="${vehicle.status == 'Rented'}">Đang Thuê</option>
                                <option value="Maintenance" th:selected="${vehicle.status == 'Maintenance'}">Bảo Trì</option>
                                <option value="Unavailable" th:selected="${vehicle.status == 'Unavailable'}">Không Khả Dụng</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Category and Transmission -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cogs text-green-600 mr-2"></i>
                        Phân Loại
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Danh Mục</label>
                            <select name="categoryId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn danh mục</option>
                                <option th:each="category : ${categories}" 
                                        th:value="${category.categoryId}" 
                                        th:text="${category.categoryName}"
                                        th:selected="${vehicle.categoryId == category.categoryId}"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại Hộp Số</label>
                            <select name="transmissionTypeId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Chọn loại hộp số</option>
                                <option th:each="transmission : ${transmissionTypes}" 
                                        th:value="${transmission.transmissionTypeId}" 
                                        th:text="${transmission.transmissionTypeName}"
                                        th:selected="${vehicle.transmissionTypeId == transmission.transmissionTypeId}"></option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="requiresLicense" th:checked="${vehicle.requiresLicense}"
                                       class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <span class="ml-2 text-sm text-gray-700">Yêu cầu bằng lái</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                        Giá Thuê
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá Theo Giờ (VNĐ)</label>
                            <input type="number" name="hourlyPrice" min="0" step="1000" th:value="${vehicle.hourlyPrice}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá Theo Ngày (VNĐ) <span class="text-red-500">*</span></label>
                            <input type="number" name="dailyPrice" required min="0" step="1000" th:value="${vehicle.dailyPrice}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá Theo Tháng (VNĐ)</label>
                            <input type="number" name="monthlyPrice" min="0" step="1000" th:value="${vehicle.monthlyPrice}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-images text-green-600 mr-2"></i>
                        Hình Ảnh
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ảnh Chính</label>
                            <input type="url" name="mainImageUrl" th:value="${vehicle.mainImageUrl}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ảnh Phụ (Mỗi URL một dòng)</label>
                            <textarea name="imageUrls" rows="3"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                      th:text="${#strings.listJoin(vehicle.imageUrls, '&#10;')}"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-star text-green-600 mr-2"></i>
                        Tính Năng
                    </h3>
                    <textarea name="features" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                              th:text="${#strings.listJoin(vehicle.features, '&#10;')}"></textarea>
                </div>

                <!-- Description -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-align-left text-green-600 mr-2"></i>
                        Mô Tả
                    </h3>
                    <textarea name="description" rows="4"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                              th:text="${vehicle.description}"></textarea>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-4">
                    <a href="/admin?tab=vehicles" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                        Hủy
                    </a>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-save mr-2"></i>Cập Nhật
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script th:inline="javascript">
        const vehicleId = /*[[${vehicle.vehicleId}]]*/ '';
        
        document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                vehicleModel: formData.get('vehicleModel'),
                licensePlate: formData.get('licensePlate'),
                vehicleType: formData.get('vehicleType'),
                yearManufactured: parseInt(formData.get('yearManufactured')),
                seats: parseInt(formData.get('seats')),
                odometer: parseInt(formData.get('odometer')),
                batteryCapacity: formData.get('batteryCapacity') ? parseFloat(formData.get('batteryCapacity')) : null,
                status: formData.get('status'),
                categoryId: formData.get('categoryId') ? parseInt(formData.get('categoryId')) : null,
                transmissionTypeId: formData.get('transmissionTypeId') ? parseInt(formData.get('transmissionTypeId')) : null,
                requiresLicense: formData.get('requiresLicense') === 'on',
                hourlyPrice: formData.get('hourlyPrice') ? parseFloat(formData.get('hourlyPrice')) : 0,
                dailyPrice: parseFloat(formData.get('dailyPrice')),
                monthlyPrice: formData.get('monthlyPrice') ? parseFloat(formData.get('monthlyPrice')) : 0,
                mainImageUrl: formData.get('mainImageUrl') || null,
                imageUrls: formData.get('imageUrls') ? formData.get('imageUrls').split('\n').filter(url => url.trim()) : [],
                features: formData.get('features') ? formData.get('features').split('\n').filter(f => f.trim()) : [],
                description: formData.get('description') || null
            };

            try {
                const response = await fetch(`/admin/vehicles/api/update/${vehicleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Cập nhật xe thành công!');
                    window.location.href = '/admin?tab=vehicles';
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        });
    </script>
</body>
</html>
