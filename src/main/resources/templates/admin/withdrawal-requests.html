<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="withdrawal-requests-content">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Quản lý Yêu cầu Rút tiền</h2>

    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Yêu cầu đang chờ xử lý</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Yêu cầu</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chủ xe</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số tiền rút</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số dư hiện tại của chủ xe</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày yêu cầu</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="withdrawal-requests-table-body">
                <tr th:each="request : ${pendingWithdrawalRequests}" th:id="${'request-row-' + request.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${request.id}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${request.owner.firstName + ' ' + request.owner.lastName}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${request.owner.email}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800" th:text="${#numbers.formatDecimal(request.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" th:text="${#numbers.formatDecimal(request.owner.balance, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#temporals.format(request.requestDate, 'dd/MM/yyyy HH:mm')}"></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800" th:text="${request.status.name()}">PENDING</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button th:data-request-id="${request.id}" onclick="approveWithdrawal(this)" class="text-green-600 hover:text-green-900 mr-3">Duyệt</button>
                        <button th:data-request-id="${request.id}" onclick="rejectWithdrawal(this)" class="text-red-600 hover:text-red-900">Từ chối</button>
                    </td>
                </tr>
                <tr th:if="${pendingWithdrawalRequests.empty}">
                    <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Không có yêu cầu rút tiền nào đang chờ xử lý.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Initial load of requests (if not already loaded by Thymeleaf)
        // fetchPendingWithdrawalRequests(); // Thymeleaf already loads initial data, AJAX is for dynamic updates
    });

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // Function to get CSRF token from meta tags
    function getCsrfToken() {
        const token = document.querySelector('meta[name="_csrf"]').content;
        const header = document.querySelector('meta[name="_csrf_header"]').content;
        return { token, header };
    }

    function fetchPendingWithdrawalRequests() {
        fetch('/admin/withdrawals/pending-ajax')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const tableBody = document.getElementById('withdrawal-requests-table-body');
                tableBody.innerHTML = ''; // Clear existing rows

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Không có yêu cầu rút tiền nào đang chờ xử lý.</td></tr>';
                    return;
                }

                data.forEach(request => {
                    const row = `
                        <tr id="request-row-${request.id}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${request.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.ownerName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.ownerEmail}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${formatCurrency(request.amount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(request.ownerBalance)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(request.requestDate).toLocaleString('vi-VN')}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${request.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-request-id="${request.id}" onclick="approveWithdrawal(this)" class="text-green-600 hover:text-green-900 mr-3">Duyệt</button>
                                <button data-request-id="${request.id}" onclick="rejectWithdrawal(this)" class="text-red-600 hover:text-red-900">Từ chối</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching pending withdrawal requests:', error);
                alert('Lỗi khi tải danh sách yêu cầu rút tiền.');
            });
    }

    function approveWithdrawal(button) {
        const requestId = button.dataset.requestId;
        if (!confirm('Bạn có chắc chắn muốn duyệt yêu cầu rút tiền này không?')) {
            return;
        }

        const adminNotes = prompt('Nhập ghi chú (tùy chọn):');
        const { token, header } = getCsrfToken();

        fetch(`/admin/withdrawals/${requestId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token // Add CSRF token
            },
            body: JSON.stringify({ adminNotes: adminNotes || 'Approved' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                fetchPendingWithdrawalRequests(); // Refresh the list
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error approving withdrawal request:', error);
            alert('Đã xảy ra lỗi khi duyệt yêu cầu rút tiền.');
        });
    }

    function rejectWithdrawal(button) {
        const requestId = button.dataset.requestId;
        const adminNotes = prompt('Nhập lý do từ chối:');

        if (adminNotes === null || adminNotes.trim() === '') {
            alert('Lý do từ chối không được để trống.');
            return;
        }

        if (!confirm('Bạn có chắc chắn muốn từ chối yêu cầu rút tiền này không?')) {
            return;
        }
        
        const { token, header } = getCsrfToken();

        fetch(`/admin/withdrawals/${requestId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token // Add CSRF token
            },
            body: JSON.stringify({ adminNotes: adminNotes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                fetchPendingWithdrawalRequests(); // Refresh the list
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error rejecting withdrawal request:', error);
            alert('Đã xảy ra lỗi khi từ chối yêu cầu rút tiền.');
        });
    }
    /*]]>*/
</script>
</html>
