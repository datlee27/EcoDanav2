<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" th:href="@{/css/profile.css}" />

  <head th:replace="~{fragments/layout :: head}"></head>

  <body class="bg-gray-50 pt-16">
    <div th:replace="~{fragments/nav :: nav}"></div>

    <main class="profile-container">
      <aside class="profile-sidebar">
        <h3>Xin chào bạn!</h3>
        <nav>
          <ul>
            <li>
              <a href="#profile-form" id="profile-link" class="active"
                ><i class="fa-solid fa-user"></i> Tài khoản của tôi</a
              >
            </li>
            <li>
              <a href="#"><i class="fa-solid fa-heart"></i> Xe yêu thích</a>
            </li>
            <li>
              <a href="#"><i class="fa-solid fa-route"></i> Chuyến của tôi</a>
            </li>
            <li>
              <a href="#documents-section" id="documents-link"><i class="fa-solid fa-id-card"></i> Giấy tờ của tôi</a>
            </li>
            <li>
              <a href="#"><i class="fa-solid fa-gift"></i> Quà tặng</a>
            </li>
            <li>
              <a href="#"><i class="fa-solid fa-location-dot"></i> Địa chỉ của tôi</a>
            </li>
            <li>
              <a href="#change-password-form" id="change-password-link"><i class="fa-solid fa-key"></i> Đổi mật khẩu</a>
            </li>
          </ul>
        </nav>
      </aside>

      <section class="profile-content">
        <!-- User Info Form -->
        <form th:action="@{/profile/update}" th:object="${user}" method="post" id="profile-form">
          <div class="content-header">
            <h2>Thông tin tài khoản</h2>
            <div>
              <a href="#" class="edit-link" id="edit-link">Chỉnh sửa</a>
              <button type="button" class="cancel-button" id="cancel-button" style="display: none">Hủy</button>
              <button type="submit" class="save-button" id="save-button" style="display: none">Lưu thay đổi</button>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <label class="info-label" for="firstName">Họ và tên</label>
              <div class="name-inputs">
                <input type="text" id="firstName" th:field="*{firstName}" class="info-value" readonly />
                <input type="text" th:field="*{lastName}" class="info-value" readonly />
              </div>
            </div>
            <div class="info-item">
              <label class="info-label" for="userDOB">Ngày sinh</label>
              <input
                type="text"
                id="userDOB"
                name="userDOB"
                th:value="${user.userDOB != null ? #temporals.format(user.userDOB, 'yyyy-MM-dd') : ''}"
                class="info-value"
                readonly
                placeholder="Chưa cập nhật"
              />
            </div>
            <div class="info-item">
              <label class="info-label" for="gender">Giới tính</label>
              <select id="gender" th:field="*{gender}" class="info-value" disabled>
                <option value="" th:selected="${user.gender == null}">Chưa cập nhật</option>
                <option value="Male" th:selected="${user.gender == 'Male'}">Nam</option>
                <option value="Female" th:selected="${user.gender == 'Female'}">Nữ</option>
                <option value="Other" th:selected="${user.gender == 'Other'}">Khác</option>
              </select>
            </div>
            <div class="info-item">
              <label class="info-label" for="phoneNumber">Số điện thoại</label>
              <input type="text" id="phoneNumber" th:field="*{phoneNumber}" class="info-value" readonly />
            </div>
            <div class="info-item">
              <label class="info-label">Email</label>
              <p class="info-value static" th:text="${user.email}">tatuanky2014sv@gmail.com</p>
            </div>
            <div class="info-item-linked">
              <div class="linked-content">
                <label class="info-label">Google</label>
                <p class="info-value static">Chưa liên kết</p>
              </div>
              <a href="#" class="link-button">Liên kết</a>
            </div>
          </div>
        </form>

        <!-- Documents Section -->
        <div id="documents-section" style="display: none">
          <div class="content-header">
            <h2>Giấy tờ của tôi</h2>
            <p style="color: #666; font-size: 14px; margin-top: 8px">
              Tải lên CCCD và giấy phép lái xe để đặt xe nhanh hơn. Hệ thống sẽ tự động trích xuất thông tin.
            </p>
          </div>

          <!-- Success/Error Messages -->
          <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
          <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

          <!-- CCCD Section -->
          <div class="document-card">
            <h3><i class="fa-solid fa-id-card"></i> Căn cước công dân (CCCD)</h3>
            <div id="cccd-status" class="document-status"></div>

            <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data" id="cccd-form">
              <input type="hidden" name="documentType" value="CitizenId" />

              <div class="upload-grid">
                <div class="upload-item">
                  <label class="upload-label">Ảnh mặt trước <span style="color: red">*</span></label>
                  <div class="upload-box" id="cccd-front-box">
                    <input
                      type="file"
                      name="frontImage"
                      id="cccd-front"
                      accept="image/*"
                      required
                      style="display: none"
                    />
                    <label for="cccd-front" class="upload-placeholder">
                      <i class="fa-solid fa-cloud-arrow-up"></i>
                      <p>Chọn ảnh hoặc kéo thả vào đây</p>
                      <span>JPG, PNG (tối đa 10MB)</span>
                    </label>
                    <img id="cccd-front-preview" class="image-preview" style="display: none" />
                  </div>
                </div>

                <div class="upload-item">
                  <label class="upload-label">Ảnh mặt sau <span style="color: red">*</span></label>
                  <div class="upload-box" id="cccd-back-box">
                    <input
                      type="file"
                      name="backImage"
                      id="cccd-back"
                      accept="image/*"
                      required
                      style="display: none"
                    />
                    <label for="cccd-back" class="upload-placeholder">
                      <i class="fa-solid fa-cloud-arrow-up"></i>
                      <p>Chọn ảnh hoặc kéo thả vào đây</p>
                      <span>JPG, PNG (tối đa 10MB)</span>
                    </label>
                    <img id="cccd-back-preview" class="image-preview" style="display: none" />
                  </div>
                </div>
              </div>

              <button type="submit" class="upload-button" id="cccd-upload-btn">
                <i class="fa-solid fa-upload"></i> Tải lên CCCD
              </button>
            </form>
          </div>

          <!-- Driver License Section -->
          <div class="document-card">
            <h3><i class="fa-solid fa-car"></i> Giấy phép lái xe (GPLX)</h3>
            <div id="gplx-status" class="document-status"></div>

            <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data" id="gplx-form">
              <input type="hidden" name="documentType" value="DriverLicense" />

              <div class="upload-grid">
                <div class="upload-item">
                  <label class="upload-label">Ảnh mặt trước <span style="color: red">*</span></label>
                  <div class="upload-box" id="gplx-front-box">
                    <input
                      type="file"
                      name="frontImage"
                      id="gplx-front"
                      accept="image/*"
                      required
                      style="display: none"
                    />
                    <label for="gplx-front" class="upload-placeholder">
                      <i class="fa-solid fa-cloud-arrow-up"></i>
                      <p>Chọn ảnh hoặc kéo thả vào đây</p>
                      <span>JPG, PNG (tối đa 10MB)</span>
                    </label>
                    <img id="gplx-front-preview" class="image-preview" style="display: none" />
                  </div>
                </div>

                <div class="upload-item">
                  <label class="upload-label">Ảnh mặt sau <span style="color: red">*</span></label>
                  <div class="upload-box" id="gplx-back-box">
                    <input
                      type="file"
                      name="backImage"
                      id="gplx-back"
                      accept="image/*"
                      required
                      style="display: none"
                    />
                    <label for="gplx-back" class="upload-placeholder">
                      <i class="fa-solid fa-cloud-arrow-up"></i>
                      <p>Chọn ảnh hoặc kéo thả vào đây</p>
                      <span>JPG, PNG (tối đa 10MB)</span>
                    </label>
                    <img id="gplx-back-preview" class="image-preview" style="display: none" />
                  </div>
                </div>
              </div>

              <button type="submit" class="upload-button" id="gplx-upload-btn">
                <i class="fa-solid fa-upload"></i> Tải lên GPLX
              </button>
            </form>
          </div>

          <!-- Info Note -->
          <div class="info-note">
            <i class="fa-solid fa-info-circle"></i>
            <div>
              <strong>Lưu ý:</strong>
              <ul>
                <li>Vui lòng chụp ảnh rõ nét, không bị mờ hoặc che khuất</li>
                <li>Giấy tờ cần còn hiệu lực và chưa hết hạn</li>
                <li>Admin sẽ xác minh giấy tờ trong vòng 24h</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Change Password Form -->
        <form th:action="@{/profile/change-password}" method="post" id="change-password-form" style="display: none">
          <div class="content-header">
            <h2>Đổi mật khẩu</h2>
            <div>
              <button type="submit" class="save-button">Lưu thay đổi</button>
            </div>
          </div>

          <!-- Display password change success/error messages -->
          <div th:if="${password_success}" class="alert alert-success" th:text="${password_success}"></div>
          <div th:if="${password_error}" class="alert alert-danger" th:text="${password_error}"></div>

          <div class="info-grid">
            <div class="info-item">
              <label class="info-label" for="currentPassword">Mật khẩu hiện tại</label>
              <input type="password" id="currentPassword" name="currentPassword" class="info-value" required />
            </div>
            <div class="info-item">
              <label class="info-label" for="newPassword">Mật khẩu mới</label>
              <input type="password" id="newPassword" name="newPassword" class="info-value" required />
            </div>
            <div class="info-item">
              <label class="info-label" for="confirmPassword">Xác nhận mật khẩu mới</label>
              <input type="password" id="confirmPassword" name="confirmPassword" class="info-value" required />
            </div>
          </div>
        </form>
      </section>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const profileForm = document.getElementById("profile-form");
        const changePasswordForm = document.getElementById("change-password-form");
        const profileLink = document.getElementById("profile-link");
        const changePasswordLink = document.getElementById("change-password-link");

        const sidebarLinks = document.querySelectorAll(".profile-sidebar a");

        function setActiveLink(activeLink) {
          sidebarLinks.forEach((link) => link.classList.remove("active"));
          activeLink.classList.add("active");
        }

        const documentsSection = document.getElementById("documents-section");
        const documentsLink = document.getElementById("documents-link");

        profileLink.addEventListener("click", function (e) {
          e.preventDefault();
          profileForm.style.display = "block";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "none";
          setActiveLink(profileLink);
        });

        documentsLink.addEventListener("click", function (e) {
          e.preventDefault();
          profileForm.style.display = "none";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "block";
          setActiveLink(documentsLink);
          loadDocuments();
        });

        changePasswordLink.addEventListener("click", function (e) {
          e.preventDefault();
          profileForm.style.display = "none";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "none";
          setActiveLink(changePasswordLink);
        });

        // Show the correct form based on hash or flash attributes
        const hash = window.location.hash;
        if (hash === "#documents") {
          profileForm.style.display = "none";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "block";
          setActiveLink(documentsLink);
          loadDocuments();
        } else if (
          document.querySelector("#change-password-form .alert-danger") ||
          document.querySelector("#change-password-form .alert-success")
        ) {
          profileForm.style.display = "none";
          changePasswordForm.style.display = "block";
          documentsSection.style.display = "none";
          setActiveLink(changePasswordLink);
        } else if (
          document.querySelector("#documents-section .alert-danger") ||
          document.querySelector("#documents-section .alert-success")
        ) {
          profileForm.style.display = "none";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "block";
          setActiveLink(documentsLink);
          loadDocuments();
        } else {
          profileForm.style.display = "block";
          changePasswordForm.style.display = "none";
          documentsSection.style.display = "none";
          setActiveLink(profileLink);
        }

        // --- Profile Edit/Cancel Logic ---
        const form = document.getElementById("profile-form");
        const editLink = document.getElementById("edit-link");
        const saveButton = document.getElementById("save-button");
        const cancelButton = document.getElementById("cancel-button");
        const inputs = form.querySelectorAll("input.info-value, select.info-value");

        let originalValues = {};
        inputs.forEach((input) => {
          originalValues[input.name || input.id] = input.value;
        });

        function setFormEditable(isEditable) {
          inputs.forEach((input) => {
            if (input.tagName.toLowerCase() === "select") {
              input.disabled = !isEditable;
            } else {
              if (!isEditable) {
                input.setAttribute("readonly", "readonly");
              } else {
                input.removeAttribute("readonly");
              }
            }
            if (isEditable) {
              input.classList.remove("readonly");
            } else {
              input.classList.add("readonly");
            }
          });

          editLink.style.display = isEditable ? "none" : "inline-block";
          saveButton.style.display = isEditable ? "inline-block" : "none";
          cancelButton.style.display = isEditable ? "inline-block" : "none";
        }

        editLink.addEventListener("click", function (e) {
          e.preventDefault();
          setFormEditable(true);
          inputs.forEach((input) => {
            originalValues[input.name || input.id] = input.value;
          });
        });

        cancelButton.addEventListener("click", function (e) {
          e.preventDefault();
          inputs.forEach((input) => {
            input.value = originalValues[input.name || input.id];
            if (input.id === "userDOB" && input._flatpickr) {
              input._flatpickr.setDate(originalValues[input.id]);
            }
          });
          setFormEditable(false);
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(form);
          fetch(form.action, {
            method: "POST",
            body: new URLSearchParams(formData),
          })
            .then((response) => {
              if (response.ok) {
                window.location.reload(); // Reload to show success message and updated data
              } else {
                throw new Error("Network response was not ok");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Có lỗi xảy ra khi cập nhật thông tin.");
            });
        });

        // --- Flatpickr Initialization ---
        const dobInput = document.getElementById("userDOB");
        flatpickr(dobInput, {
          locale: "vn",
          altInput: true,
          altFormat: "d/m/Y",
          dateFormat: "Y-m-d",
          allowInput: true,
          onOpen: function (selectedDates, dateStr, instance) {
            if (instance.input.hasAttribute("readonly")) {
              instance.close();
            }
          },
          onReady: function (selectedDates, dateStr, instance) {
            const flatpickrInput = instance.altInput;
            const originalInput = instance.input;
            flatpickrInput.classList.add("info-value");
            const syncState = () => {
              if (originalInput.hasAttribute("readonly")) {
                flatpickrInput.setAttribute("readonly", "readonly");
                flatpickrInput.classList.add("readonly");
              } else {
                flatpickrInput.removeAttribute("readonly");
                flatpickrInput.classList.remove("readonly");
              }
            };
            syncState();
            const observer = new MutationObserver(syncState);
            observer.observe(originalInput, { attributes: true, attributeFilter: ["readonly"] });
          },
        });

        setFormEditable(false);

        // --- Document Upload Logic ---
        function setupImagePreview(inputId, previewId, boxId) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);
          const box = document.getElementById(boxId);
          const placeholder = box.querySelector(".upload-placeholder");

          input.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              // Validate file size (10MB)
              if (file.size > 10 * 1024 * 1024) {
                alert("Kích thước file không được vượt quá 10MB!");
                input.value = "";
                return;
              }

              // Validate file type
              if (!file.type.startsWith("image/")) {
                alert("Vui lòng chọn file ảnh (JPG, PNG)!");
                input.value = "";
                return;
              }

              const reader = new FileReader();
              reader.onload = function (event) {
                preview.src = event.target.result;
                preview.style.display = "block";
                if (placeholder) placeholder.style.display = "none";
              };
              reader.readAsDataURL(file);
            }
          });
        }

        // Setup image previews for all upload inputs
        setupImagePreview("cccd-front", "cccd-front-preview", "cccd-front-box");
        setupImagePreview("cccd-back", "cccd-back-preview", "cccd-back-box");
        setupImagePreview("gplx-front", "gplx-front-preview", "gplx-front-box");
        setupImagePreview("gplx-back", "gplx-back-preview", "gplx-back-box");

        // Load user's documents
        function loadDocuments() {
          fetch("/documents/type/CitizenId")
            .then((response) => response.json())
            .then((data) => {
              const statusDiv = document.getElementById("cccd-status");
              if (data.success && data.document) {
                const doc = data.document;
                statusDiv.innerHTML = `
                            <div class="document-info ${doc.isVerified ? "verified" : "pending"}">
                                <div class="doc-status-badge">
                                    ${
                                      doc.isVerified
                                        ? '<i class="fa-solid fa-check-circle"></i> Đã xác minh'
                                        : '<i class="fa-solid fa-clock"></i> Chờ xác minh'
                                    }
                                </div>
                                <div class="doc-details">
                                    <div class="doc-field">
                                        <label><strong>Số CCCD:</strong></label>
                                        <input type="text" id="cccd-number" value="${doc.documentNumber || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Họ tên:</strong></label>
                                        <input type="text" id="cccd-name" value="${doc.fullName || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Ngày sinh:</strong></label>
                                        <input type="date" id="cccd-dob" value="${doc.dob || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Ngày cấp:</strong></label>
                                        <input type="date" id="cccd-issued-date" value="${doc.issuedDate || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Nơi cấp:</strong></label>
                                        <input type="text" id="cccd-issued-place" value="${doc.issuedPlace || ""}">
                                    </div>
                                </div>
                                ${
                                  doc.frontImageUrl
                                    ? `
                                    <div class="doc-images">
                                        <img src="${doc.frontImageUrl}" alt="CCCD mặt trước" onclick="window.open('${
                                        doc.frontImageUrl
                                      }', '_blank')">
                                        ${
                                          doc.backImageUrl
                                            ? `<img src="${doc.backImageUrl}" alt="CCCD mặt sau" onclick="window.open('${doc.backImageUrl}', '_blank')">`
                                            : ""
                                        }
                                    </div>
                                `
                                    : ""
                                }
                                <div class="doc-actions">
                                    <button class="btn btn-primary btn-sm" onclick="updateDocumentInfo('${
                                      doc.documentId
                                    }', 'cccd')">
                                        <i class="fa-solid fa-save"></i> Cập nhật thông tin
                                    </button>
                                </div>
                            </div>
                        `;
                document.getElementById("cccd-upload-btn").innerHTML =
                  '<i class="fa-solid fa-rotate"></i> Cập nhật CCCD';
              } else {
                statusDiv.innerHTML = '<p class="no-doc-message">Chưa tải lên CCCD</p>';
              }
            })
            .catch((error) => console.error("Error loading CCCD:", error));

          fetch("/documents/type/DriverLicense")
            .then((response) => response.json())
            .then((data) => {
              const statusDiv = document.getElementById("gplx-status");
              if (data.success && data.document) {
                const doc = data.document;
                statusDiv.innerHTML = `
                            <div class="document-info ${doc.isVerified ? "verified" : "pending"}">
                                <div class="doc-status-badge">
                                    ${
                                      doc.isVerified
                                        ? '<i class="fa-solid fa-check-circle"></i> Đã xác minh'
                                        : '<i class="fa-solid fa-clock"></i> Chờ xác minh'
                                    }
                                </div>
                                <div class="doc-details">
                                    <div class="doc-field">
                                        <label><strong>Số GPLX:</strong></label>
                                        <input type="text" id="gplx-number" value="${doc.documentNumber || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Họ tên:</strong></label>
                                        <input type="text" id="gplx-name" value="${doc.fullName || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Ngày sinh:</strong></label>
                                        <input type="date" id="gplx-dob" value="${doc.dob || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Ngày cấp:</strong></label>
                                        <input type="date" id="gplx-issued-date" value="${doc.issuedDate || ""}">
                                    </div>
                                    <div class="doc-field">
                                        <label><strong>Nơi cấp:</strong></label>
                                        <input type="text" id="gplx-issued-place" value="${doc.issuedPlace || ""}">
                                    </div>
                                </div>
                                ${
                                  doc.frontImageUrl
                                    ? `
                                    <div class="doc-images">
                                        <img src="${doc.frontImageUrl}" alt="GPLX mặt trước" onclick="window.open('${
                                        doc.frontImageUrl
                                      }', '_blank')">
                                        ${
                                          doc.backImageUrl
                                            ? `<img src="${doc.backImageUrl}" alt="GPLX mặt sau" onclick="window.open('${doc.backImageUrl}', '_blank')">`
                                            : ""
                                        }
                                    </div>
                                `
                                    : ""
                                }
                                <div class="doc-actions">
                                    <button class="btn btn-primary btn-sm" onclick="updateDocumentInfo('${
                                      doc.documentId
                                    }', 'gplx')">
                                        <i class="fa-solid fa-save"></i> Cập nhật thông tin
                                    </button>
                                </div>
                            </div>
                        `;
                document.getElementById("gplx-upload-btn").innerHTML =
                  '<i class="fa-solid fa-rotate"></i> Cập nhật GPLX';
              } else {
                statusDiv.innerHTML = '<p class="no-doc-message">Chưa tải lên GPLX</p>';
              }
            })
            .catch((error) => console.error("Error loading GPLX:", error));
        }

        // Add loading state to upload buttons
        document.getElementById("cccd-form").addEventListener("submit", function () {
          const btn = document.getElementById("cccd-upload-btn");
          btn.disabled = true;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý OCR...';
        });

        document.getElementById("gplx-form").addEventListener("submit", function () {
          const btn = document.getElementById("gplx-upload-btn");
          btn.disabled = true;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý OCR...';
        });
      });

      // Function to update document information
      function updateDocumentInfo(documentId, docType) {
        const prefix = docType === "cccd" ? "cccd" : "gplx";

        const data = {
          documentNumber: document.getElementById(prefix + "-number").value,
          fullName: document.getElementById(prefix + "-name").value,
          dob: document.getElementById(prefix + "-dob").value,
          issuedDate: document.getElementById(prefix + "-issued-date").value,
          issuedPlace: document.getElementById(prefix + "-issued-place").value,
        };

        fetch(`/documents/${documentId}/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              alert("Cập nhật thông tin thành công!");
            } else {
              alert("Lỗi: " + (result.message || "Không thể cập nhật thông tin"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Có lỗi xảy ra khi cập nhật thông tin");
          });
      }
    </script>
  </body>
</html>
