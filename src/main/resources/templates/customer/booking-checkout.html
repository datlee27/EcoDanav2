<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Xác nhận đặt xe - EcoDana</title>
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .payment-method {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .payment-method:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .payment-method.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Navigation -->
<div th:replace="~{fragments/nav :: nav}"></div>

<!-- Main Content -->
<main class="pt-20 pb-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div class="flex items-center text-green-500">
                        <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">
                            <i class="fas fa-check"></i>
                        </div>
                        <span class="ml-2 font-semibold">Chọn xe</span>
                    </div>
                    <div class="w-24 h-1 bg-green-500 mx-4"></div>
                    <div class="flex items-center text-green-500">
                        <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 font-semibold">Xác nhận & Thanh toán</span>
                    </div>
                    <div class="w-24 h-1 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-400">
                        <div class="w-10 h-10 bg-gray-300 text-white rounded-full flex items-center justify-center font-bold">3</div>
                        <span class="ml-2">Hoàn tất</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Main Content -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Vehicle Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-car text-green-500 mr-2"></i>
                        Thông tin xe
                    </h2>
                    
                    <div class="flex gap-4">
                        <img th:src="@{'/images/vehicles/' + ${#strings.toLowerCase(vehicle.vehicleModel).replace(' ', '-')} + '.jpg'}"
                             th:alt="${vehicle.vehicleModel}"
                             class="w-32 h-32 object-cover rounded-lg">
                        
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 mb-2" th:text="${vehicle.vehicleModel}">VinFast VF8</h3>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <i class="fas fa-id-card w-5 mr-2"></i>
                                    <span>Biển số: <span class="font-semibold" th:text="${vehicle.licensePlate}">43A-12345</span></span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <i class="fas fa-chair w-5 mr-2"></i>
                                    <span>Số chỗ: <span class="font-semibold" th:text="${vehicle.seats} + ' chỗ'">5 chỗ</span></span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <i class="fas fa-cog w-5 mr-2"></i>
                                    <span th:text="${vehicle.transmissionType != null ? vehicle.transmissionType.transmissionTypeName : 'Số tự động'}">Số tự động</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <i class="fas fa-bolt w-5 mr-2"></i>
                                    <span>Điện</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rental Period -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                            Thời gian thuê
                        </h2>
                        <button type="button" onclick="toggleEditTime()" class="text-green-600 hover:text-green-700 font-semibold text-sm">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editTimeText">Chỉnh sửa</span>
                        </button>
                    </div>
                    
                    <!-- Display Mode -->
                    <div id="timeDisplayMode">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-1">Nhận xe</p>
                                <p class="font-bold text-gray-900" id="displayPickupTime" th:text="${pickupDateTime}">01/01/2025 21:00</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-1">Trả xe</p>
                                <p class="font-bold text-gray-900" id="displayReturnTime" th:text="${returnDateTime}">05/01/2025 20:00</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-blue-500 mr-2"></i>
                                <span class="text-gray-700">Thời gian thuê: 
                                    <span class="font-bold text-blue-600" id="displayRentalDays">
                                        <span th:if="${remainingHours != null && remainingHours > 0}">
                                            <span th:text="${fullDays}">1</span> ngày <span th:text="${remainingHours}">2</span> giờ
                                        </span>
                                        <span th:if="${remainingHours == null || remainingHours == 0}">
                                            <span th:text="${rentalDays}">2</span> ngày
                                        </span>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Mode (Hidden by default) -->
                    <div id="timeEditMode" class="hidden">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nhận xe</label>
                                <input type="date" id="editPickupDate" th:value="${pickupDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 mb-2">
                                <input type="time" id="editPickupTime" th:value="${pickupTime}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Trả xe</label>
                                <input type="date" id="editReturnDate" th:value="${returnDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 mb-2">
                                <input type="time" id="editReturnTime" th:value="${returnTime}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="button" onclick="saveTimeChanges()" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-semibold">
                                <i class="fas fa-check mr-1"></i> Lưu thay đổi
                            </button>
                            <button type="button" onclick="cancelTimeEdit()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-semibold">
                                <i class="fas fa-times mr-1"></i> Hủy
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Discount Code -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-tag text-green-500 mr-2"></i>
                            Mã giảm giá
                        </h2>
                    </div>
                    
                    <!-- Show applied discount info if exists -->
                    <div th:if="${discountCode != null}" id="discountApplied" class="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="font-semibold text-green-700">Đã áp dụng: <span th:text="${discountCode}">SUMMER2025</span></span>
                            </div>
                            <button type="button" onclick="removeDiscount()" class="text-red-600 hover:text-red-700 text-sm font-semibold">
                                <i class="fas fa-times mr-1"></i> Xóa
                            </button>
                        </div>
                        <p class="text-sm text-gray-600">Giảm <span class="font-bold text-green-600" th:text="${#numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">500.000 ₫</span></p>
                    </div>
                    
                    <!-- Input form - auto-filled if discount exists -->
                    <div id="discountForm">
                        <div class="flex gap-2">
                            <input type="text" id="checkoutDiscountCode" 
                                   th:value="${discountId != null ? discountId : ''}"
                                   placeholder="Nhập mã giảm giá"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <button type="button" onclick="applyCheckoutDiscount()" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                                Áp dụng
                            </button>
                        </div>
                        <div id="checkoutDiscountMessage" class="mt-2 text-sm hidden"></div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-credit-card text-green-500 mr-2"></i>
                        Phương thức thanh toán
                    </h2>
                    
                    <form id="checkoutForm" th:action="@{/booking/create}" method="post">
                        <!-- Hidden inputs -->
                        <input type="hidden" name="vehicleId" th:value="${vehicleId}">
                        <input type="hidden" name="pickupDate" th:value="${pickupDate}">
                        <input type="hidden" name="pickupTime" th:value="${pickupTime}">
                        <input type="hidden" name="returnDate" th:value="${returnDate}">
                        <input type="hidden" name="returnTime" th:value="${returnTime}">
                        <input type="hidden" name="pickupLocation" th:value="${pickupLocation}">
                        <input type="hidden" name="vehicleRentalFee" th:value="${rentalPrice}"> <input type="hidden" name="totalAmount" th:value="${totalAmount}"> <input type="hidden" name="rentalDays" th:value="${rentalDays}">
                        <input type="hidden" name="discountId" th:value="${discountId}">
                        <input type="hidden" name="discountAmount" th:value="${discountAmount}">
                        <input type="hidden" name="paymentMethod" id="paymentMethodInput" value="Cash">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Cash Payment -->
<!--                            <div class="payment-method selected border-2 rounded-lg p-4" data-method="Cash" onclick="selectPaymentMethod('Cash')">-->
<!--                                <div class="text-center">-->
<!--                                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">-->
<!--                                        <i class="fas fa-money-bill-wave text-3xl text-green-500"></i>-->
<!--                                    </div>-->
<!--                                    <h3 class="font-semibold text-gray-900 mb-1">Tiền mặt</h3>-->
<!--                                    <p class="text-xs text-gray-600">Thanh toán khi nhận xe</p>-->
<!--                                </div>-->
<!--                            </div>-->
                            
                            <!-- Bank Transfer -->
                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4" data-method="BankTransfer" onclick="selectPaymentMethod('BankTransfer')">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-university text-3xl text-blue-500"></i>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 mb-1">Chuyển khoản</h3>
                                    <p class="text-xs text-gray-600">Chuyển khoản ngân hàng</p>
                                </div>
                            </div>
                            
                            <!-- Credit Card -->
<!--                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4" data-method="CreditCard" onclick="selectPaymentMethod('CreditCard')">-->
<!--                                <div class="text-center">-->
<!--                                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">-->
<!--                                        <i class="fas fa-credit-card text-3xl text-purple-500"></i>-->
<!--                                    </div>-->
<!--                                    <h3 class="font-semibold text-gray-900 mb-1">Thẻ tín dụng</h3>-->
<!--                                    <p class="text-xs text-gray-600">Visa, Mastercard</p>-->
<!--                                </div>-->
<!--                            </div>-->
                        </div>
                        
                        <!-- Bank Transfer Info (Hidden by default) -->
                        <div id="bankTransferInfo" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-semibold mb-2">Thông tin chuyển khoản:</h4>
                            <div class="text-sm space-y-1">
                                <p><strong>Ngân hàng:</strong> Vietcombank</p>
                                <p><strong>Số tài khoản:</strong> 0123456789</p>
                                <p><strong>Chủ tài khoản:</strong> CÔNG TY ECODANA</p>
                                <p><strong>Nội dung:</strong> <span class="font-mono bg-white px-2 py-1 rounded">ECODANA [SĐT]</span></p>
                            </div>
                        </div>
                        
                        <!-- Credit Card Info (Hidden by default) -->
                        <div id="creditCardInfo" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-info-circle text-purple-500 mr-2"></i>
                                Bạn sẽ được chuyển đến trang thanh toán an toàn để nhập thông tin thẻ.
                            </p>
                        </div>
                    </form>
                </div>

                <!-- Terms and Conditions -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-file-contract text-green-500 mr-2"></i>
                        Điều khoản & Điều kiện
                    </h2>
                    
                    <div class="space-y-3 text-sm text-gray-700">
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>Sử dụng xe đúng mục đích, không vi phạm pháp luật</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>Không sử dụng xe để cầm cố, thế chấp</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>Giữ gìn xe sạch sẽ, không hút thuốc trong xe</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>Trả xe đúng thời gian đã thỏa thuận</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="agreeTerms" class="mt-1 mr-3 w-5 h-5 text-green-500 rounded focus:ring-green-500" required>
                            <span class="text-sm text-gray-700">
                                Tôi đã đọc và đồng ý với <a href="#" class="text-green-600 hover:underline font-semibold">Điều khoản sử dụng</a> 
                                và <a href="#" class="text-green-600 hover:underline font-semibold">Chính sách bảo mật</a> của EcoDana
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                    <h2 class="text-xl font-bold mb-4">Tóm tắt đơn hàng</h2>
                    
                    <!-- Price Breakdown -->
                    <div class="space-y-3 text-sm mb-4" id="priceBreakdown">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-600 font-medium">Đơn giá thuê (<span id="summaryRentalDays" th:text="${rentalDays}">5</span> ngày)</span>
                                <span class="font-semibold" id="summaryRentalPrice" th:text="${#numbers.formatDecimal(rentalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">5.000.000 ₫</span>
                            </div>
                            <div th:if="${remainingHours != null && remainingHours > 0}" class="text-xs text-gray-500 ml-2">
                                • <span th:text="${fullDays}">2</span> ngày × <span th:text="${#numbers.formatDecimal(dailyPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">1.100.000 ₫</span><br/>
                                • <span th:text="${remainingHours}">2</span> giờ × <span th:text="${#numbers.formatDecimal(hourlyPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">50.000 ₫</span>
                            </div>
                        </div>
                        
                        <div th:if="${discountCode != null and discountCode != ''}" class="flex justify-between text-green-600">
                            <span class="font-medium">
                                <i class="fas fa-tag mr-1"></i>
                                Giảm giá (<span th:text="${discountCode}">SUMMER2025</span>)
                            </span>
                            <span class="font-semibold" th:text="'-' + ${#numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">-500.000 ₫</span>
                        </div>
                    </div>
                    
                    <div class="border-t-2 border-gray-300 pt-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-900">Tổng cộng</span>
                            <span class="text-2xl font-bold text-green-500" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">4.860.401 ₫</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button type="button" onclick="confirmBooking()" 
                                class="w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition-all shadow-md hover:shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i>
                            Xác nhận đặt xe
                        </button>
                        
                        <a th:href="@{'/vehicles/' + ${vehicleId}}" 
                           class="block w-full text-center border-2 border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-50 transition-all">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Quay lại
                        </a>
                    </div>
                    
                    <!-- Security Badge -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex items-center justify-center text-sm text-gray-600">
                            <i class="fas fa-lock text-green-500 mr-2"></i>
                            <span>Thanh toán an toàn & bảo mật</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JavaScript -->
<script>
    // Initialize data from server
    const initialData = {
        pickupDate: /*[[${pickupDate}]]*/ '',
        pickupTime: /*[[${pickupTime}]]*/ '',
        returnDate: /*[[${returnDate}]]*/ '',
        returnTime: /*[[${returnTime}]]*/ '',
        rentalDays: /*[[${rentalDays}]]*/ 0,
        dailyPrice: /*[[${vehicle.getDailyPriceFromJson()}]]*/ 0,
        discountId: /*[[${discountId}]]*/ '',
        discountAmount: /*[[${discountAmount}]]*/ 0
    };

    // Toggle edit time mode
    function toggleEditTime() {
        const displayMode = document.getElementById('timeDisplayMode');
        const editMode = document.getElementById('timeEditMode');
        const editText = document.getElementById('editTimeText');
        
        if (editMode.classList.contains('hidden')) {
            // Show edit mode
            displayMode.classList.add('hidden');
            editMode.classList.remove('hidden');
            editText.textContent = 'Hủy';
            // Values are already populated by Thymeleaf
        } else {
            // Show display mode
            cancelTimeEdit();
        }
    }
    
    function cancelTimeEdit() {
        document.getElementById('timeDisplayMode').classList.remove('hidden');
        document.getElementById('timeEditMode').classList.add('hidden');
        document.getElementById('editTimeText').textContent = 'Chỉnh sửa';
    }
    
    function saveTimeChanges() {
        const pickupDate = document.getElementById('editPickupDate').value;
        const pickupTime = document.getElementById('editPickupTime').value;
        const returnDate = document.getElementById('editReturnDate').value;
        const returnTime = document.getElementById('editReturnTime').value;
        
        if (!pickupDate || !pickupTime || !returnDate || !returnTime) {
            alert('Vui lòng điền đầy đủ thông tin!');
            return;
        }
        
        // Calculate new rental days (same logic as vehicle-detail)
        const pickupDateTime = new Date(`${pickupDate}T${pickupTime}`);
        const returnDateTime = new Date(`${returnDate}T${returnTime}`);
        
        if (returnDateTime <= pickupDateTime) {
            alert('Ngày trả xe phải sau ngày nhận xe!');
            return;
        }
        
        const diffMilliseconds = returnDateTime - pickupDateTime;
        const totalHours = diffMilliseconds / (1000 * 60 * 60);
        
        let diffDays = 0;
        if (totalHours > 0) {
            diffDays = Math.ceil(totalHours / 24);
            if (diffDays === 0 && diffMilliseconds > 0) {
                diffDays = 1;
            }
        } else {
            diffDays = 1;
        }
        
        // Update display
        const formatDate = (date, time) => {
            const d = new Date(date);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()} ${time}`;
        };
        
        document.getElementById('displayPickupTime').textContent = formatDate(pickupDate, pickupTime);
        document.getElementById('displayReturnTime').textContent = formatDate(returnDate, returnTime);
        document.getElementById('displayRentalDays').textContent = diffDays + ' ngày';
        
        // Update hidden form inputs
        document.querySelector('input[name="pickupDate"]').value = pickupDate;
        document.querySelector('input[name="pickupTime"]').value = pickupTime;
        document.querySelector('input[name="returnDate"]').value = returnDate;
        document.querySelector('input[name="returnTime"]').value = returnTime;
        document.querySelector('input[name="rentalDays"]').value = diffDays;
        
        // Recalculate prices
        recalculatePrices(diffDays);
        
        // Update initial data
        initialData.pickupDate = pickupDate;
        initialData.pickupTime = pickupTime;
        initialData.returnDate = returnDate;
        initialData.returnTime = returnTime;
        initialData.rentalDays = diffDays;
        
        cancelTimeEdit();
    }
    
    function recalculatePrices(days) {
        // Submit form to reload with new dates
        const form = document.getElementById('checkoutForm');
        
        // Change form action to checkout (not create)
        form.action = '/booking/checkout';
        
        // Submit to reload with new data
        form.submit();
    }
    
    // Apply discount on checkout page
    async function applyCheckoutDiscount() {
        const discountCode = document.getElementById('checkoutDiscountCode').value.trim();
        const rentalPrice = parseFloat(document.getElementById('summaryRentalPrice').textContent.replace(/[^\d]/g, ''));
        
        if (!discountCode) {
            showCheckoutDiscountMessage('Vui lòng nhập mã giảm giá!', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/discounts/validate?code=${encodeURIComponent(discountCode)}&amount=${rentalPrice}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.valid) {
                // Update hidden inputs
                document.querySelector('input[name="discountId"]').value = data.discount.voucherCode;
                document.querySelector('input[name="discountAmount"]').value = data.calculatedAmount;
                
                // Submit form to reload with discount
                const form = document.getElementById('checkoutForm');
                form.action = '/booking/checkout';
                form.submit();
            } else {
                showCheckoutDiscountMessage(data.message || 'Mã giảm giá không hợp lệ!', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showCheckoutDiscountMessage('Có lỗi xảy ra khi áp dụng mã giảm giá!', 'error');
        }
    }
    
    function showCheckoutDiscountMessage(message, type) {
        const messageEl = document.getElementById('checkoutDiscountMessage');
        messageEl.textContent = message;
        messageEl.className = 'mt-2 text-sm ' + (type === 'success' ? 'text-green-600' : 'text-red-600');
        messageEl.classList.remove('hidden');
    }
    
    function removeDiscount() {
        if (confirm('Bạn có chắc muốn xóa mã giảm giá?')) {
            document.querySelector('input[name="discountId"]').value = '';
            document.querySelector('input[name="discountAmount"]').value = '0';
            
            // Submit form to reload without discount
            const form = document.getElementById('checkoutForm');
            form.action = '/booking/checkout';
            form.submit();
        }
    }
    
    function selectPaymentMethod(method) {
        // Remove selected class from all
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('selected', 'border-green-500', 'bg-green-50');
            el.classList.add('border-gray-200');
        });
        
        // Add selected class to clicked
        const selected = document.querySelector(`[data-method="${method}"]`);
        selected.classList.add('selected', 'border-green-500');
        selected.classList.remove('border-gray-200');
        
        // Update hidden input
        document.getElementById('paymentMethodInput').value = method;
        
        // Show/hide payment info
        document.getElementById('bankTransferInfo').classList.add('hidden');
        document.getElementById('creditCardInfo').classList.add('hidden');
        
        if (method === 'BankTransfer') {
            document.getElementById('bankTransferInfo').classList.remove('hidden');
        } else if (method === 'CreditCard') {
            document.getElementById('creditCardInfo').classList.remove('hidden');
        }
    }
    
    function confirmBooking() {
        const agreeTerms = document.getElementById('agreeTerms');
        
        if (!agreeTerms.checked) {
            alert('Vui lòng đồng ý với điều khoản và điều kiện!');
            agreeTerms.focus();
            return;
        }
        
        // Submit form
        document.getElementById('checkoutForm').submit();
    }
    
    // Set minimum date for date inputs on page load
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const pickupDateInput = document.getElementById('editPickupDate');
        const returnDateInput = document.getElementById('editReturnDate');
        
        pickupDateInput.min = today;
        returnDateInput.min = today;
        
        // When pickup date changes, update return date minimum
        pickupDateInput.addEventListener('change', function() {
            returnDateInput.min = this.value;
            if (returnDateInput.value && returnDateInput.value < this.value) {
                returnDateInput.value = this.value;
            }
        });
        
        // Auto-focus discount input if it has value (came from previous page)
        const discountInput = document.getElementById('checkoutDiscountCode');
        if (discountInput && discountInput.value) {
            console.log('Discount code pre-filled:', discountInput.value);
        }
    });
</script>

</body>
</html>
