<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head}"></head>

  <body class="bg-gray-50">
    <!-- Navigation -->
    <div th:replace="~{fragments/nav :: nav}"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ƒê∆°n ƒë·∫∑t xe c·ªßa t√¥i</h1>
            <p class="text-gray-600">Qu·∫£n l√Ω t·∫•t c·∫£ c√°c ƒë∆°n ƒë·∫∑t xe c·ªßa b·∫°n</p>
          </div>
          <button
            id="refreshBtn"
            class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all"
          >
            <i class="fas fa-sync-alt mr-2"></i>
            L√†m m·ªõi
          </button>
        </div>

        <!-- Alert Messages -->
        <div th:if="${success}" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <p class="text-green-800" th:text="${success}">Success message</p>
          </div>
        </div>

        <div th:if="${error}" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
            <p class="text-red-800" th:text="${error}">Error message</p>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
          <div class="flex border-b border-gray-200 overflow-x-auto">
            <button
              class="filter-tab active px-6 py-3 font-medium text-green-500 border-b-2 border-green-500"
              data-status="all"
            >
              T·∫•t c·∫£ (<span id="count-all" th:text="${bookings.size()}">0</span>)
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="Pending">
              Ch·ªù duy·ªát (<span id="count-pending" th:text="${#lists.size(bookings.?[status.name() == 'Pending'])}"
                >0</span
              >)
            </button>
            <button
              class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500 relative"
              data-status="AwaitingDeposit,Approved"
            >
              Ch·ªù thanh to√°n (<span
                id="count-approved"
                th:text="${#lists.size(bookings.?[status.name() == 'AwaitingDeposit' || status.name() == 'Approved'])}"
                >0</span
              >)
              <span
                th:if="${#lists.size(bookings.?[status.name() == 'AwaitingDeposit' || status.name() == 'Approved']) > 0}"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse"
              >
                NEW
              </span>
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="Confirmed">
              ƒê√£ thanh to√°n (<span
                id="count-confirmed"
                th:text="${#lists.size(bookings.?[status.name() == 'Confirmed'])}"
                >0</span
              >)
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="Ongoing">
              ƒêang thu√™ (<span id="count-ongoing" th:text="${#lists.size(bookings.?[status.name() == 'Ongoing'])}"
                >0</span
              >)
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="Completed">
              Ho√†n th√†nh (<span id="count-completed" th:text="${#lists.size(bookings.?[status.name() == 'Completed'])}"
                >0</span
              >)
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="RefundPending">
              H·ªßy chuy·∫øn (<span id="count-refund-pending" th:text="${#lists.size(bookings.?[status.name() == 'RefundPending'])}"
                >0</span
              >)
            </button>
            <button
              class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500"
              data-status="Cancelled,Rejected"
            >
              ƒê√£ h·ªßy/T·ª´ ch·ªëi (<span
                id="count-cancelled"
                th:text="${#lists.size(bookings.?[status.name() == 'Cancelled' || status.name() == 'Rejected'])}"
                >0</span
              >)
            </button>
            <button class="filter-tab px-6 py-3 font-medium text-gray-600 hover:text-green-500" data-status="Approved">
              ƒê√£ ho√†n ti·ªÅn (<span id="count-refunded" th:text="${#lists.size(bookings.?[status.name() == 'Approved' && cancelReason != null])}"
                >0</span
              >)
            </button>
          </div>
        </div>

        <!-- Bookings List -->
        <div th:if="${bookings.isEmpty()}" class="bg-white rounded-lg shadow-md p-12 text-center">
          <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t xe n√†o</h3>
          <p class="text-gray-500 mb-6">H√£y b·∫Øt ƒë·∫ßu thu√™ xe ƒë·ªÉ tr·∫£i nghi·ªám d·ªãch v·ª• c·ªßa ch√∫ng t√¥i!</p>
          <a
            th:href="@{/vehicles}"
            class="inline-block bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition-all"
          >
            <i class="fas fa-car mr-2"></i>
            Thu√™ xe ngay
          </a>
        </div>

        <div th:if="${!bookings.isEmpty()}" class="space-y-4">
          <div
            th:each="booking : ${bookings}"
            th:class="${booking.status.name() == 'AwaitingDeposit' || booking.status.name() == 'Approved'} ? 'booking-card bg-blue-50 border-2 border-blue-400 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-all' : 'booking-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-all'"
            th:attr="data-status=${booking.status}"
          >
            <div class="p-6">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <!-- Booking Code & Status -->
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-lg font-semibold text-gray-900" th:text="${booking.bookingCode}">BK1234567890</h3>
                    <span
                      class="status-badge px-3 py-1 rounded-full text-xs font-semibold"
                      th:classappend="${booking.status == 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                                                       booking.status == 'Approved' ? 'bg-blue-100 text-blue-800' :
                                                       booking.status == 'Ongoing' ? 'bg-green-100 text-green-800' :
                                                       booking.status == 'Completed' ? 'bg-gray-100 text-gray-800' :
                                                       booking.status == 'RefundPending' ? 'bg-orange-100 text-orange-800' :
                                                       booking.status == 'Cancelled' ? 'bg-red-100 text-red-800' :
                                                       'bg-gray-100 text-gray-800'}"
                      th:text="${booking.status == 'Pending' ? 'Ch·ªù duy·ªát' :
                                               booking.status == 'Approved' ? 'ƒê√£ duy·ªát' :
                                               booking.status == 'Ongoing' ? 'ƒêang thu√™' :
                                               booking.status == 'Completed' ? 'Ho√†n th√†nh' :
                                               booking.status == 'RefundPending' ? 'H·ªßy chuy·∫øn' :
                                               booking.status == 'Cancelled' ? 'ƒê√£ h·ªßy' :
                                               booking.status}"
                    >
                      Ch·ªù duy·ªát
                    </span>
                  </div>
                  <p class="text-sm text-gray-500">
                    <i class="far fa-calendar mr-1"></i>
                    ƒê·∫∑t ng√†y:
                    <span th:text="${#temporals.format(booking.createdDate, 'dd/MM/yyyy HH:mm')}"
                      >01/01/2025 10:00</span
                    >
                  </p>
                </div>

                <!-- Price -->
                <div class="mt-3 md:mt-0 text-right">
                  <p class="text-sm text-gray-600">T·ªïng ti·ªÅn</p>
                  <p
                    class="text-2xl font-bold text-green-500"
                    th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"
                  >
                    1.231.937 ‚Ç´
                  </p>
                </div>
              </div>

              <!-- Refund Information (if refunded) -->
              <div th:if="${booking.status == 'Approved' && booking.cancelReason != null}" class="p-4 bg-green-50 border-2 border-green-300 rounded-lg mb-4">
                <h4 class="font-semibold text-green-900 mb-3">
                  <i class="fas fa-check-circle text-green-600 mr-2"></i>Th√¥ng tin ho√†n ti·ªÅn
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p class="text-xs text-green-700 mb-1">S·ªë ti·ªÅn ho√†n</p>
                    <p class="text-2xl font-bold text-green-600" th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                      1.231.937 ‚Ç´
                    </p>
                  </div>
                  <div>
                    <p class="text-xs text-green-700 mb-1">Tr·∫°ng th√°i</p>
                    <p class="text-lg font-semibold text-green-800">
                      <i class="fas fa-check-circle mr-1"></i>ƒê√£ ho√†n ti·ªÅn
                    </p>
                  </div>
                </div>
                <!-- Refund Proof Image -->
                <div class="mt-4 pt-4 border-t border-green-200">
                  <p class="text-xs text-green-700 mb-2">·∫¢nh ch·ª©ng minh chuy·ªÉn kho·∫£n</p>
                  <div id="refundProofContainer" class="flex gap-2 flex-wrap">
                    <button
                      type="button"
                      onclick="viewRefundProofImage(this)"
                      th:attr="data-booking-id=${booking.bookingId}"
                      class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all text-sm font-medium"
                    >
                      <i class="fas fa-image mr-1"></i>Xem ·∫£nh
                    </button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">ƒêang t·∫£i ·∫£nh...</p>
                </div>
              </div>

              <!-- Rental Details -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg mb-4">
                <div>
                  <p class="text-xs text-gray-500 mb-1">Nh·∫≠n xe</p>
                  <p class="font-semibold text-gray-800">
                    <i class="fas fa-calendar-check text-green-500 mr-2"></i>
                    <span th:text="${#temporals.format(booking.pickupDateTime, 'dd/MM/yyyy HH:mm')}"
                      >01/01/2025 21:00</span
                    >
                  </p>
                </div>
                <div>
                  <p class="text-xs text-gray-500 mb-1">Tr·∫£ xe</p>
                  <p class="font-semibold text-gray-800">
                    <i class="fas fa-calendar-times text-red-500 mr-2"></i>
                    <span th:text="${#temporals.format(booking.returnDateTime, 'dd/MM/yyyy HH:mm')}"
                      >05/01/2025 20:00</span
                    >
                  </p>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-wrap gap-2">
                <a
                  th:href="@{'/booking/confirmation/' + ${booking.bookingId}}"
                  class="btn-detail px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all text-sm font-medium"
                >
                  <i class="fas fa-eye mr-1"></i>
                  Xem chi ti·∫øt
                </a>

                <button
                  th:if="${booking.status == 'Pending'}"
                  onclick="cancelBooking(this)"
                  th:attr="data-booking-id=${booking.bookingId}"
                  class="btn-cancel px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm font-medium"
                >
                  <i class="fas fa-times mr-1"></i>
                  H·ªßy ƒë∆°n
                </button>

                <button
                  th:if="${booking.status.toString() == 'Completed' && !booking.hasFeedback}"
                  onclick="openFeedbackModal(this)"
                  th:attr="data-booking-id=${booking.bookingId},data-return-datetime=${#temporals.format(booking.returnDateTime, 'yyyy-MM-dd''T''HH:mm:ss')}"
                  class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all text-sm font-medium"
                >
                  <i class="fas fa-star mr-1"></i>
                  ƒê√°nh gi√°
                </button>

                <span
                  th:if="${booking.status.toString() == 'Completed' && booking.hasFeedback}"
                  class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg text-sm font-medium"
                >
                  <i class="fas fa-check mr-1"></i>
                  ƒê√£ ƒë√°nh gi√°
                </span>

                <!-- RefundPending Actions -->
                <div th:if="${booking.status == 'RefundPending'}" class="flex flex-col sm:flex-row gap-3 mt-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                  <button
                    onclick="confirmReturnSuccess(this)"
                    th:attr="data-booking-id=${booking.bookingId}"
                    class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-semibold text-base shadow-md hover:shadow-lg"
                  >
                    <i class="fas fa-check-circle mr-2"></i>
                    ‚úì Th√†nh c√¥ng
                  </button>

                  <button
                    onclick="confirmReturnFailed(this)"
                    th:attr="data-booking-id=${booking.bookingId}"
                    class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold text-base shadow-md hover:shadow-lg"
                  >
                    <i class="fas fa-times-circle mr-2"></i>
                    ‚úó T·ª´ ch·ªëi
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Cancel Modal -->
    <div id="cancelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-xl font-semibold mb-4">X√°c nh·∫≠n h·ªßy ƒë∆°n</h3>
        <p class="text-gray-600 mb-4">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n ƒë·∫∑t xe n√†y?</p>

        <form id="cancelForm" method="post">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">L√Ω do h·ªßy (t√πy ch·ªçn)</label>
            <textarea
              name="cancelReason"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
              placeholder="Nh·∫≠p l√Ω do h·ªßy..."
            ></textarea>
          </div>

          <div class="flex gap-3">
            <button
              type="button"
              onclick="closeCancelModal()"
              class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              ƒê√≥ng
            </button>
            <button type="submit" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
              X√°c nh·∫≠n h·ªßy
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Feedback Modal -->
    <div
      id="feedbackModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-lg max-w-lg w-full p-6">
        <h3 class="text-xl font-semibold mb-4">ƒê√°nh gi√° chuy·∫øn ƒëi</h3>
        <p class="text-gray-600 mb-4">H√£y chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ chuy·∫øn ƒëi n√†y</p>

        <form id="feedbackForm" method="post" action="">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ƒê√°nh gi√° sao <span class="text-red-500">*</span></label
            >
            <div class="flex items-center space-x-2">
              <div class="rating-stars">
                <input type="radio" id="star5" name="rating" value="5" class="hidden" />
                <label for="star5" class="star text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">‚òÖ</label>

                <input type="radio" id="star4" name="rating" value="4" class="hidden" />
                <label for="star4" class="star text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">‚òÖ</label>

                <input type="radio" id="star3" name="rating" value="3" class="hidden" />
                <label for="star3" class="star text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">‚òÖ</label>

                <input type="radio" id="star2" name="rating" value="2" class="hidden" />
                <label for="star2" class="star text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">‚òÖ</label>

                <input type="radio" id="star1" name="rating" value="1" class="hidden" />
                <label for="star1" class="star text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">‚òÖ</label>
              </div>
              <span id="rating-text" class="text-sm text-gray-600 ml-2"></span>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Nh·∫≠n x√©t chi ti·∫øt</label>
            <textarea
              name="content"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
              placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ xe, d·ªãch v·ª•, ch·ªß xe..."
            ></textarea>
          </div>

          <div id="validation-message" class="mb-4 text-red-500 text-sm hidden"></div>

          <div class="flex gap-3">
            <button
              type="button"
              onclick="closeFeedbackModal()"
              class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              onclick="submitFeedback()"
              class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
            >
              G·ª≠i ƒë√°nh gi√°
            </button>
          </div>
        </form>
      </div>
    </div>

    <!--    &lt;!&ndash; Footer &ndash;&gt;-->
    <!--    <div th:replace="~{fragments/footer :: footer}"></div>-->

    <script>
      // Filter tabs
      document.querySelectorAll(".filter-tab").forEach((tab) => {
        tab.addEventListener("click", function () {
          // Remove active from all tabs
          document.querySelectorAll(".filter-tab").forEach((t) => {
            t.classList.remove("active", "text-green-500", "border-b-2", "border-green-500");
            t.classList.add("text-gray-600");
          });

          // Add active to clicked tab
          this.classList.remove("text-gray-600");
          this.classList.add("active", "text-green-500", "border-b-2", "border-green-500");

          // Filter bookings
          const status = this.getAttribute("data-status");
          const bookings = document.querySelectorAll(".booking-card");

          bookings.forEach((booking) => {
            const bookingStatus = booking.getAttribute("data-status");
            // Support multiple statuses separated by comma
            const statuses = status.split(",");

            if (status === "all" || statuses.includes(bookingStatus)) {
              booking.style.display = "block";
            } else {
              booking.style.display = "none";
            }
          });
        });
      });

      // Cancel booking
      function cancelBooking(button) {
        const bookingId = button.getAttribute("data-booking-id");
        const form = document.getElementById("cancelForm");
        form.action = "/booking/cancel/" + bookingId;
        document.getElementById("cancelModal").classList.remove("hidden");
      }

      function closeCancelModal() {
        document.getElementById("cancelModal").classList.add("hidden");
      }

      // Close modal on outside click
      document.getElementById("cancelModal").addEventListener("click", function (e) {
        if (e.target === this) {
          closeCancelModal();
        }
      });

      // Feedback modal functions
      function openFeedbackModal(button) {
        const bookingId = button.getAttribute("data-booking-id");
        const form = document.getElementById("feedbackForm");
        form.action = "/feedback/submit/" + bookingId;
        document.getElementById("feedbackModal").classList.remove("hidden");
      }

      function closeFeedbackModal() {
        document.getElementById("feedbackModal").classList.add("hidden");
        // Reset form
        document.getElementById("feedbackForm").reset();
        updateStarDisplay(0);
      }

      // Close feedback modal on outside click
      document.getElementById("feedbackModal").addEventListener("click", function (e) {
        if (e.target === this) {
          closeFeedbackModal();
        }
      });

      // Star rating functionality
      const stars = document.querySelectorAll(".star");
      const ratingText = document.getElementById("rating-text");
      const ratingInputs = document.querySelectorAll('input[name="rating"]');

      function updateStarDisplay(rating) {
        // ratingInputs are in order: star5 (value=5), star4 (value=4), star3 (value=3), star2 (value=2), star1 (value=1)
        // index 0 = 5 stars, index 1 = 4 stars, index 2 = 3 stars, index 3 = 2 stars, index 4 = 1 star
        stars.forEach((star, index) => {
          const starValue = 5 - index; // Convert index to star value (index 0 = 5, index 4 = 1)
          if (starValue <= rating) {
            star.classList.remove("text-gray-300");
            star.classList.add("text-yellow-400");
          } else {
            star.classList.remove("text-yellow-400");
            star.classList.add("text-gray-300");
          }
        });

        const ratingTexts = ["", "R·∫•t t·ªá", "T·ªá", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];
        ratingText.textContent = ratingTexts[rating];
      }

      stars.forEach((star, index) => {
        star.addEventListener("click", function () {
          const rating = 5 - index; // First star (index 0) = 5, last star (index 4) = 1
          ratingInputs[index].checked = true; // index 0 = star5, index 1 = star4, etc.
          updateStarDisplay(rating);
        });

        star.addEventListener("mouseenter", function () {
          const rating = 5 - index;
          updateStarDisplay(rating);
        });
      });

      // Reset stars on mouse leave
      document.querySelector(".rating-stars").addEventListener("mouseleave", function () {
        const checkedRating = document.querySelector('input[name="rating"]:checked');
        const rating = checkedRating ? parseInt(checkedRating.value) : 0;
        updateStarDisplay(rating);
      });

      // Function to validate and submit feedback
      function submitFeedback() {
        const validationMsg = document.getElementById("validation-message");
        validationMsg.classList.add("hidden");

        // Get selected rating
        const selectedRating = document.querySelector('input[name="rating"]:checked');
        const content = document.querySelector('textarea[name="content"]').value.trim();

        // Validate rating
        if (!selectedRating) {
          validationMsg.textContent = "Vui l√≤ng ch·ªçn ƒë√°nh gi√° sao";
          validationMsg.classList.remove("hidden");
          return;
        }

        // Validate content (optional but recommended)
        if (!content) {
          validationMsg.textContent = "Vui l√≤ng nh·∫≠p nh·∫≠n x√©t chi ti·∫øt";
          validationMsg.classList.remove("hidden");
          return;
        }

        // Submit the form
        const form = document.getElementById("feedbackForm");
        const formData = new FormData(form);

        // Debug: Check if action is set
        console.log("Form action:", form.action);
        if (!form.action || form.action === "") {
          validationMsg.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·∫∑t xe ƒë·ªÉ ƒë√°nh gi√°";
          validationMsg.classList.remove("hidden");
          return;
        }

        fetch(form.action, {
          method: "POST",
          body: new URLSearchParams(formData),
        })
          .then((response) => {
            if (response.ok) {
              alert("C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!");
              window.location.reload();
            } else {
              throw new Error("Network response was not ok");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            validationMsg.textContent = "C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i.";
            validationMsg.classList.remove("hidden");
          });
      }

      // Check URL parameter for status filter
      window.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const filterStatus = urlParams.get("status");

        if (filterStatus) {
          // Find and click the corresponding tab
          const tab = document.querySelector(`.filter-tab[data-status="${filterStatus}"]`);
          if (tab) {
            tab.click();
          }
        }
      });

      // Update refresh button
      const refreshBtn = document.getElementById("refreshBtn");
      if (refreshBtn) {
        refreshBtn.onclick = function () {
          location.reload();
        };
      }

      // Show notification if there are newly approved bookings
      window.addEventListener("DOMContentLoaded", function () {
        // Check if we just reloaded
        const justReloaded = sessionStorage.getItem("justReloaded");

        if (justReloaded === "true") {
          sessionStorage.removeItem("justReloaded");

          // Count approved bookings
          const approvedBookings = document.querySelectorAll('.booking-card[data-status="Approved"]');

          if (approvedBookings.length > 0) {
            // Show notification
            showNotification("C√≥ " + approvedBookings.length + " ƒë∆°n ƒë·∫∑t xe ƒë√£ ƒë∆∞·ª£c duy·ªát!");

            // Auto switch to Approved tab after 1 second
            setTimeout(function () {
              const approvedTab = document.querySelector('.filter-tab[data-status="Approved"]');
              if (approvedTab) {
                approvedTab.click();
              }
            }, 1000);
          }
        }
      });

      // Override refresh button to set flag
      if (refreshBtn) {
        refreshBtn.onclick = function () {
          sessionStorage.setItem("justReloaded", "true");
          location.reload();
        };
      }

      // Show notification function
      function showNotification(message) {
        const notification = document.createElement("div");
        notification.className =
          "fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in";
        notification.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + message;
        document.body.appendChild(notification);

        setTimeout(function () {
          notification.style.opacity = "0";
          notification.style.transition = "opacity 0.5s";
          setTimeout(function () {
            notification.remove();
          }, 500);
        }, 3000);
      }

      // Show notification for approved bookings
      window.addEventListener("DOMContentLoaded", function () {
        const approvedBookings = document.querySelectorAll(
          '.booking-card[data-status="AwaitingDeposit"], .booking-card[data-status="Approved"]'
        );

        if (approvedBookings.length > 0 && !sessionStorage.getItem("approvalNotificationShown")) {
          const notification = document.createElement("div");
          notification.className =
            "fixed top-24 right-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-md";
          notification.innerHTML = `
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-check-circle text-blue-500 text-2xl"></i>
                    </div>
                    <div>
                        <p class="font-bold text-lg">üéâ Xe ƒë√£ ƒë∆∞·ª£c duy·ªát!</p>
                        <p class="text-sm">B·∫°n c√≥ ${approvedBookings.length} ƒë∆°n ƒë√£ ƒë∆∞·ª£c ch·∫•p nh·∫≠n. Vui l√≤ng thanh to√°n!</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            `;
          document.body.appendChild(notification);
          sessionStorage.setItem("approvalNotificationShown", "true");

          setTimeout(() => {
            notification.style.opacity = "0";
            notification.style.transition = "opacity 0.5s";
            setTimeout(() => notification.remove(), 500);
          }, 5000);
        }
      });

      // Confirm return success
      function confirmReturnSuccess(button) {
        const bookingId = button.getAttribute("data-booking-id");
        if (confirm("X√°c nh·∫≠n ho√†n chuy·∫øn th√†nh c√¥ng?")) {
          fetch("/booking/confirm-return-success/" + bookingId, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          })
            .then(response => {
              if (response.ok) {
                alert("Ho√†n chuy·∫øn th√†nh c√¥ng!");
                window.location.reload();
              } else {
                alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
              }
            })
            .catch(error => {
              console.error("Error:", error);
              alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }
      }

      // Confirm return failed
      function confirmReturnFailed(button) {
        const bookingId = button.getAttribute("data-booking-id");
        const reason = prompt("Vui l√≤ng nh·∫≠p l√Ω do kh√¥ng th√†nh c√¥ng:");
        if (reason !== null) {
          fetch("/booking/confirm-return-failed/" + bookingId, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ reason: reason })
          })
            .then(response => {
              if (response.ok) {
                alert("ƒê√£ ghi nh·∫≠n kh√¥ng th√†nh c√¥ng!");
                window.location.reload();
              } else {
                alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
              }
            })
            .catch(error => {
              console.error("Error:", error);
              alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }
      }

      // Enforce 5-day feedback window after return time
      window.addEventListener("DOMContentLoaded", function () {
        const feedbackButtons = document.querySelectorAll(
          'button[onclick="openFeedbackModal(this)"][data-return-datetime]'
        );
        feedbackButtons.forEach(function (btn) {
          const returnAtStr = btn.getAttribute("data-return-datetime");
          const returnAt = new Date(returnAtStr);
          if (isNaN(returnAt.getTime())) {
            return;
          }
          const fiveDaysMs = 5 * 24 * 60 * 60 * 1000;
          const deadlineMs = returnAt.getTime() + fiveDaysMs;
          if (Date.now() > deadlineMs) {
            const expired = document.createElement("span");
            expired.className = "px-4 py-2 bg-gray-300 text-gray-600 rounded-lg text-sm font-medium";
            expired.innerHTML = '<i class="fas fa-hourglass-end mr-1"></i> H·∫øt h·∫°n ƒë√°nh gi√°';
            btn.replaceWith(expired);
          }
        });
      });

      // View refund proof image
      window.viewRefundProofImage = function(button) {
        const bookingId = button.getAttribute('data-booking-id');
        
        // Fetch refund request for this booking
        fetch('/admin/api/refund-requests/by-booking/' + bookingId)
          .then(response => {
            if (!response.ok) {
              throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin ho√†n ti·ªÅn');
            }
            return response.json();
          })
          .then(data => {
            if (data.transferProofImagePath) {
              // Open image in lightbox
              const lightbox = document.createElement('div');
              lightbox.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
              lightbox.onclick = function(e) {
                if (e.target === this) {
                  lightbox.remove();
                }
              };
              
              lightbox.innerHTML = `
                <div class="max-w-2xl w-full">
                  <div class="relative bg-white rounded-lg overflow-hidden">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 z-10">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                    <img src="${data.transferProofImagePath}" alt="·∫¢nh ch·ª©ng minh chuy·ªÉn kho·∫£n" class="w-full h-auto">
                  </div>
                </div>
              `;
              
              document.body.appendChild(lightbox);
            } else {
              alert('Ch∆∞a c√≥ ·∫£nh ch·ª©ng minh chuy·ªÉn kho·∫£n');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('L·ªói: ' + error.message);
          });
      };
    </script>
  </body>
</html>
