<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body>
<style>
    .primary { color: #4CAF50; }
    .bg-primary { background-color: #4CAF50; }
    .hidden { display: none; }
    .status-pending { background-color: #fef9c3; color: #a16207; }
    .status-approved, .status-active { background-color: #dcfce7; color: #166534; }
    .status-ongoing { background-color: #dbeafe; color: #1e40af; }
    .status-completed { background-color: #e5e7eb; color: #374151; } /* Reverted to original color */
    .status-rejected, .status-cancelled { background-color: #fee2e2; color: #991b1b; }
</style>
<div th:replace="~{fragments/nav :: nav}"></div>
<div th:replace="~{owner/owner-sidebar :: sidebar}"></div>

<div class="ml-64 mt-16">
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Booking Management</h1>
                    <p class="text-gray-600">Manage your bookings</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800" th:text="${currentUser?.firstName + ' ' + currentUser?.lastName ?: 'Owner'}">Owner</p>
                        <p class="text-sm text-gray-600">Car Owner</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Booking Management Content -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex flex-wrap gap-4">
                    <button class="px-4 py-2 bg-primary text-white rounded-lg font-medium filter-btn" data-status="all">All Bookings</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium filter-btn" data-status="pending">Pending</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium filter-btn" data-status="approved">Approved</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium filter-btn" data-status="ongoing">Ongoing</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium filter-btn" data-status="completed">Completed</button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium filter-btn" data-status="cancelled">Cancelled</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Customer</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Car</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Rental Period</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Amount</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    <tr th:each="booking : ${bookings}" class="hover:bg-gray-50" th:attr="data-status=${#strings.toLowerCase(booking.status.name())}">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gray-300 rounded-full"><img th:if="${booking.user != null and booking.user.avatarUrl != null}" th:src="${booking.user.avatarUrl}" class="w-full h-full rounded-full object-cover"/></div>
                                <div>
                                    <p class="font-semibold text-gray-800" th:text="${booking.user != null ? (booking.user.firstName + ' ' + booking.user.lastName) : 'N/A'}"></p>
                                    <p class="text-sm text-gray-600" th:text="${booking.user != null ? booking.user.email : 'N/A'}"></p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-gray-800" th:text="${booking.vehicle != null ? booking.vehicle.vehicleModel : 'N/A'}"></p>
                                <p class="text-sm text-gray-600" th:text="${booking.vehicle != null ? (booking.vehicle.vehicleType + ' • ' + booking.vehicle.yearManufactured) : 'N/A'}"></p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-gray-800" th:text="${#temporals.format(booking.pickupDateTime, 'dd/MM/yyyy') + ' - ' + #temporals.format(booking.returnDateTime, 'dd/MM/yyyy')}"></p>
                            </div>
                        </td>
                        <td class="px-6 py-4"><p class="font-semibold text-primary" th:text="${booking.totalAmount != null ? ('$' + booking.totalAmount) : '$0'}"></p></td>
                        <td class="px-6 py-4"><span th:class="'px-3 py-1 rounded-full text-sm font-medium status-' + ${#strings.toLowerCase(booking.status.name())}" th:text="${booking.status ?: 'Unknown'}"></span></td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-3">
                                <button th:attr="onclick=|viewBooking('${booking.bookingId}')|" class="text-blue-600 hover:text-blue-800" title="View Details"><i class="fas fa-eye"></i></button>
                                <th:block th:if="${booking.status.name() == 'Pending'}">
                                    <button th:attr="onclick=|acceptBooking('${booking.bookingId}')|" class="text-green-600 hover:text-green-800" title="Approve"><i class="fas fa-check"></i></button>
                                    <button th:attr="onclick=|openDeclineBookingModal('${booking.bookingId}')|" class="text-red-600 hover:text-red-800" title="Reject"><i class="fas fa-times"></i></button>
                                </th:block>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Booking Detail Modal -->
<div id="booking-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[95vh] flex flex-col">
        <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-xl">
            <h3 class="text-xl font-semibold text-gray-800">Booking Details</h3>
            <button onclick="closeBookingDetailModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto" id="booking-detail-content">
            <!-- Dynamic content will be injected here by JavaScript -->
        </div>
        <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 rounded-b-xl border-t" id="booking-detail-actions">
            <button onclick="closeBookingDetailModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">Close</button>
            <button id="modal-edit-button" onclick="openEditBookingModal()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-edit mr-2"></i>Edit</button>
            <!-- Action buttons will be dynamically added/removed here -->
            <button id="modal-complete-button" onclick="completeBooking(currentBookingData.bookingId)" class="hidden bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-flag-checkered mr-2"></i>Complete</button>
            <button id="modal-cancel-button" onclick="openCancelBookingModal(currentBookingData.bookingId)" class="hidden bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600"><i class="fas fa-ban mr-2"></i>Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Booking Modal -->
<div id="edit-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Edit Booking</h3>
            <button onclick="closeEditBookingModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="edit-booking-form" onsubmit="submitEditBookingForm(event)">
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-booking-id" name="bookingId">
                <div>
                    <label for="edit-pickup-datetime" class="block text-sm font-medium text-gray-700">Pickup DateTime</label>
                    <input type="datetime-local" id="edit-pickup-datetime" name="pickupDateTime" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="edit-return-datetime" class="block text-sm font-medium text-gray-700">Return DateTime</label>
                    <input type="datetime-local" id="edit-return-datetime" name="returnDateTime" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="edit-total-amount" class="block text-sm font-medium text-gray-700">Total Amount</label>
                    <input type="number" id="edit-total-amount" name="totalAmount" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="edit-booking-status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="edit-booking-status" name="status" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                        <option th:each="status : ${T(com.ecodana.evodanavn1.model.Booking.BookingStatus).values()}" th:value="${status}" th:text="${status.name()}"></option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 border-t">
                <button type="button" onclick="closeEditBookingModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Decline Booking Modal -->
<div id="decline-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Decline Booking</h3>
            <button onclick="closeDeclineBookingModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6">
            <label for="decline-reason" class="block text-sm font-medium text-gray-700 mb-2">Reason for declining:</label>
            <textarea id="decline-reason" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter reason here..."></textarea>
        </div>
        <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 border-t">
            <button type="button" onclick="closeDeclineBookingModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
            <button type="button" onclick="submitDeclineBooking()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">Decline Booking</button>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div id="cancel-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Cancel Booking</h3>
            <button onclick="closeCancelBookingModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6">
            <label for="cancel-reason" class="block text-sm font-medium text-gray-700 mb-2">Reason for cancellation:</label>
            <textarea id="cancel-reason" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter reason here..."></textarea>
        </div>
        <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 border-t">
                <button type="button" onclick="closeCancelBookingModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                <button type="button" onclick="submitCancelBooking()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600">Confirm Cancellation</button>
            </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let currentBookingData = null; // Store the whole booking object
    
    // Lấy CSRF token từ Thymeleaf một cách an toàn
    const csrfToken = /*[[${_csrf.token}]]*/ null;
    const csrfHeaderName = /*[[${_csrf.headerName}]]*/ null;
    const csrfHeaders = { 'Content-Type': 'application/json' };
    if (csrfToken) {
        csrfHeaders[csrfHeaderName] = csrfToken;
    }

    function viewBooking(bookingId) {
        console.log('viewBooking triggered for ID:', bookingId);
        fetch(`/owner/management/bookings/${bookingId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch booking details. Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                currentBookingData = data;
                const content = document.getElementById('booking-detail-content');
                
                let detailsHtml = `
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 flex items-center"><i class="fas fa-receipt mr-3 text-primary"></i>Booking Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <p><strong>ID:</strong> <span>${data.bookingId || 'N/A'}</span></p>
                            <p><strong>Code:</strong> <span>${data.bookingCode || 'N/A'}</span></p>
                            <p><strong>Status:</strong> <span class="px-2 py-1 rounded-full text-xs font-medium status-${data.status ? data.status.toLowerCase() : ''}">${data.status || 'N/A'}</span></p>
                            <p><strong>Total Amount:</strong> <span>${data.totalAmount ? '$' + data.totalAmount : 'N/A'}</span></p>
                            <p><strong>Pickup:</strong> <span>${data.pickupDateTime ? new Date(data.pickupDateTime).toLocaleString() : 'N/A'}</span></p>
                            <p><strong>Return:</strong> <span>${data.returnDateTime ? new Date(data.returnDateTime).toLocaleString() : 'N/A'}</span></p>
                            <p><strong>Rental Type:</strong> <span>${data.rentalType || 'N/A'}</span></p>
                            <p><strong>Payment Method:</strong> <span>${data.paymentMethod || 'N/A'}</span></p>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 flex items-center"><i class="fas fa-user-circle mr-3 text-primary"></i>Customer Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <p><strong>Name:</strong> <span>${data.customerName || 'N/A'}</span></p>
                            <p><strong>Email:</strong> <span>${data.customerEmail || 'N/A'}</span></p>
                            <p><strong>Phone:</strong> <span>${data.customerPhone || 'N/A'}</span></p>
                            <p><strong>Date of Birth:</strong> <span>${data.customerDOB ? new Date(data.customerDOB).toLocaleDateString() : 'N/A'}</span></p>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 flex items-center"><i class="fas fa-car-side mr-3 text-primary"></i>Vehicle Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <p><strong>Model:</strong> <span>${data.vehicleModel || 'N/A'}</span></p>
                            <p><strong>License Plate:</strong> <span>${data.licensePlate || 'N/A'}</span></p>
                            <p><strong>Category:</strong> <span>${data.vehicleCategory || 'N/A'}</span></p>
                            <p><strong>Transmission:</strong> <span>${data.transmission || 'N/A'}</span></p>
                        </div>
                    </div>
                `;
                content.innerHTML = detailsHtml;
                
                // Show/hide action buttons in detail modal based on status
                const completeBtn = document.getElementById('modal-complete-button');
                const cancelBtn = document.getElementById('modal-cancel-button');
                const editBtn = document.getElementById('modal-edit-button');

                // Hide all action buttons first
                completeBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                editBtn.classList.remove('hidden'); // Edit is always available from detail view

                switch (data.status) {
                    case 'Approved':
                    case 'Ongoing':
                        completeBtn.classList.remove('hidden');
                        cancelBtn.classList.remove('hidden');
                        break;
                    // For Completed, Rejected, Cancelled, only Edit (if applicable) and Close are shown
                }

                document.getElementById('booking-detail-modal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error fetching booking details:', error);
                alert('Could not load booking details. Please try again. Error: ' + error.message);
            });
    }

    function closeBookingDetailModal() {
        document.getElementById('booking-detail-modal').classList.add('hidden');
    }

    function openEditBookingModal() {
        if (!currentBookingData) return;
        
        const pickupDate = new Date(currentBookingData.pickupDateTime).toISOString().slice(0, 16);
        const returnDate = new Date(currentBookingData.returnDateTime).toISOString().slice(0, 16);

        document.getElementById('edit-booking-id').value = currentBookingData.bookingId;
        document.getElementById('edit-pickup-datetime').value = pickupDate;
        document.getElementById('edit-return-datetime').value = returnDate;
        document.getElementById('edit-total-amount').value = currentBookingData.totalAmount;
        document.getElementById('edit-booking-status').value = currentBookingData.status;

        closeBookingDetailModal();
        document.getElementById('edit-booking-modal').classList.remove('hidden');
    }

    function closeEditBookingModal() {
        document.getElementById('edit-booking-modal').classList.add('hidden');
    }

    function submitEditBookingForm(event) {
        event.preventDefault();
        const form = document.getElementById('edit-booking-form');
        const formData = new FormData(form);
        const bookingId = formData.get('bookingId');
        
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        fetch(`/owner/bookings/${bookingId}/update`, {
            method: 'POST',
            headers: csrfHeaders,
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if(result.success) {
                alert('Booking updated successfully!');
                location.reload();
            } else {
                alert('Error updating booking: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        });
    }

    function acceptBooking(bookingId) {
        console.log('acceptBooking triggered for ID:', bookingId);
        if (!confirm("Are you sure you want to approve this booking?")) return;
        fetch(`/owner/management/bookings/${bookingId}/approve`, { method: 'POST', headers: csrfHeaders })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Booking approved successfully!');
                location.reload();
            } else {
                throw new Error(data.message || 'Failed to approve booking.');
            }
        })
        .catch(error => {
            console.error('Error approving booking:', error);
            alert(error.message);
        });
    }

    function openDeclineBookingModal(bookingId) {
        console.log('openDeclineBookingModal triggered for ID:', bookingId);
        currentBookingId = bookingId;
        document.getElementById('decline-booking-modal').classList.remove('hidden');
    }

    function closeDeclineBookingModal() {
        document.getElementById('decline-booking-modal').classList.add('hidden');
        document.getElementById('decline-reason').value = '';
    }

    function submitDeclineBooking() {
        console.log('submitDeclineBooking triggered for ID:', currentBookingId);
        if (!currentBookingId) return;
        const reason = document.getElementById('decline-reason').value;
        if (!reason || reason.trim() === '') {
            alert('Please enter a reason for declining.');
            return;
        }

        fetch(`/owner/management/bookings/${currentBookingId}/reject`, {
            method: 'POST',
            headers: csrfHeaders,
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Booking rejected successfully!');
                closeDeclineBookingModal();
                location.reload();
            } else {
                throw new Error(data.message || 'Failed to reject booking.');
            }
        })
        .catch(error => {
            console.error('Error rejecting booking:', error);
            alert(error.message);
        });
    }

    function completeBooking(bookingId) {
        console.log('completeBooking triggered for ID:', bookingId);
        if (!confirm("Are you sure you want to mark this booking as completed?")) return;

        fetch(`/owner/management/bookings/${bookingId}/complete`, { method: 'POST', headers: csrfHeaders })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Booking marked as completed successfully!');
                location.reload();
            } else {
                throw new Error(data.message || 'Failed to complete booking.');
            }
        })
        .catch(error => {
            console.error('Error completing booking:', error);
            alert(error.message);
        });
    }

    function openCancelBookingModal(bookingId) {
        console.log('openCancelBookingModal triggered for ID:', bookingId);
        currentBookingId = bookingId;
        document.getElementById('cancel-booking-modal').classList.remove('hidden');
    }

    function closeCancelBookingModal() {
        document.getElementById('cancel-booking-modal').classList.add('hidden');
        document.getElementById('cancel-reason').value = '';
    }

    function submitCancelBooking() {
        console.log('submitCancelBooking triggered for ID:', currentBookingId);
        if (!currentBookingId) return;
        const reason = document.getElementById('cancel-reason').value;
        if (!reason || reason.trim() === '') {
            alert('Please enter a reason for cancellation.');
            return;
        }

        fetch(`/owner/management/bookings/${currentBookingId}/cancel`, {
            method: 'POST',
            headers: csrfHeaders,
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Booking cancelled successfully!');
                closeCancelBookingModal();
                location.reload();
            } else {
                throw new Error(data.message || 'Failed to cancel booking.');
            }
        })
        .catch(error => {
            console.error('Error cancelling booking:', error);
            alert(error.message);
        });
    }

    document.querySelectorAll(".filter-btn").forEach((button) => {
        button.addEventListener("click", () => {
            const status = button.getAttribute("data-status");
            document.querySelectorAll("tbody tr").forEach((row) => {
                if (status === "all" || row.getAttribute("data-status") === status) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
            document.querySelectorAll(".filter-btn").forEach((btn) => btn.classList.replace("bg-primary", "bg-gray-100"));
            button.classList.replace("bg-gray-100", "bg-primary");
        });
    });
    /*]]>*/
</script>

</body>
</html>
