<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/layout :: head}"></div>
    <link href="/css/sidebar-common.css" rel="stylesheet" />
    <link href="/css/owner-dashboard.css" rel="stylesheet" />
    <style>
        /* Status Badge Styles */
        .status-Available {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-Rented {
            background-color: #fef9c3;
            color: #a16207;
        }
        .status-Maintenance {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-Unavailable {
            background-color: #f3f4f6;
            color: #374151;
        }
        .status-badge {
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            display: inline-flex;
            align-items: center;
        }
        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            animation: modalFadeIn 0.3s ease-in-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal.hidden { display: none; }
        .modal-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content {
            position: relative; background-color: white; border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            display: flex; flex-direction: column;
            max-width: 800px; width: 90%; max-height: 90vh; /* Adjust width if needed */
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn { from { transform: translateY(-30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; flex-shrink: 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { display: flex; justify-content: flex-end; padding: 1rem 1.5rem; background-color: #f9fafb; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
        /* Primary Color Styles (Ensure these are defined) */
        .bg-primary { background-color: #4CAF50; } /* Example primary color */
        .hover\:bg-accent:hover { background-color: #45a049; } /* Example accent color */
        .text-primary { color: #4CAF50; }
        .focus\:ring-primary:focus { --tw-ring-color: #4CAF50; }
        .focus\:border-primary:focus { border-color: #4CAF50; }
        .text-primary { color: #4CAF50; }
        .feature-checkbox { /* Style for feature checkboxes */
            width: 1rem; height: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex h-screen bg-gray-100 overflow-hidden">
    <div th:replace="~{fragments/sidebar-layout :: layout(navContentFragment=~{owner/owner-sidebar-nav :: nav})}"></div>

    <div class="flex-1 flex flex-col overflow-hidden">
        <div class="flex items-center justify-between h-16 px-4 bg-white shadow-sm border-b flex-shrink-0">
            <button id="sidebar-toggle" class="text-gray-600 hover:text-gray-900 lg:hidden">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="flex-grow md:flex-grow-0">
                <h1 class="text-lg font-semibold text-gray-800 truncate">Car Management</h1>
                <p class="text-xs text-gray-500 hidden sm:block">Manage your vehicles</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="notificationBell" class="relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notificationBadge" class="hidden absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-500 rounded-full">0</span>
                    </button>
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-900">Thông báo</h3>
                            <button onclick="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-700">Đánh dấu tất cả đã đọc</button>
                        </div>
                        <div id="notificationList" class="max-h-96 overflow-y-auto">
                            <div class="p-4 text-center text-gray-500">
                                <i class="fas fa-bell-slash text-3xl mb-2"></i>
                                <p>Không có thông báo mới</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <button id="userMenuButton" class="flex items-center space-x-2 p-2 hover:bg-gray-100 rounded-lg transition">
                        <div th:if="${currentUser?.avatarUrl != null and !currentUser.avatarUrl.isEmpty()}" class="w-8 h-8 rounded-full overflow-hidden">
                            <img th:src="${currentUser.avatarUrl}" alt="Avatar" class="w-full h-full object-cover">
                        </div>
                        <i th:unless="${currentUser?.avatarUrl != null and !currentUser.avatarUrl.isEmpty()}" class="fas fa-user-circle text-2xl text-gray-500"></i>
                        <span class="hidden md:inline text-sm font-medium text-gray-700" th:text="${currentUser?.firstName}">Owner</span>
                        <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                    </button>
                    <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <div class="p-3 border-b border-gray-200">
                            <p class="text-sm font-semibold text-gray-800" th:text="${currentUser?.firstName + ' ' + currentUser?.lastName}">Owner User</p>
                            <p class="text-xs text-gray-500" th:text="${currentUser?.role?.roleName}">Owner</p>
                        </div>
                        <div class="py-1">
                            <a href="/" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-home w-5 mr-2 text-gray-500"></i>
                                Trang chủ
                            </a>
                            <a href="/owner/profile" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user-edit w-5 mr-2 text-gray-500"></i>
                                Hồ sơ
                            </a>
                            <a href="/logout" class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                <i class="fas fa-sign-out-alt w-5 mr-2"></i>
                                Đăng Xuất
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto px-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">My Cars</h2>
                    <button onclick="toggleModal('add-car-modal')" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition-colors flex items-center text-sm font-medium">
                        <i class="fas fa-plus mr-2"></i>Add New Car
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div onclick="quickFilterStatus('Available')" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500 cursor-pointer hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Available</p>
                                <p class="text-2xl font-bold text-green-600" th:text="${availableCount ?: 0}">0</p>
                                <p class="text-xs text-gray-500 mt-1">Sẵn sàng</p>
                            </div>
                            <i class="fas fa-check-circle text-4xl text-green-500 opacity-60"></i>
                        </div>
                    </div>
                    <div onclick="quickFilterStatus('Rented')" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500 cursor-pointer hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Rented</p>
                                <p class="text-2xl font-bold text-yellow-600" th:text="${rentedCount ?: 0}">0</p>
                                <p class="text-xs text-gray-500 mt-1">Đang cho thuê</p>
                            </div>
                            <i class="fas fa-car text-4xl text-yellow-500 opacity-60"></i>
                        </div>
                    </div>
                    <div onclick="quickFilterStatus('Maintenance')" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-red-500 cursor-pointer hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Maintenance</p>
                                <p class="text-2xl font-bold text-red-600" th:text="${maintenanceCount ?: 0}">0</p>
                                <p class="text-xs text-gray-500 mt-1">Bảo trì</p>
                            </div>
                            <i class="fas fa-wrench text-4xl text-red-500 opacity-60"></i>
                        </div>
                    </div>
                    <div onclick="quickFilterStatus('Unavailable')" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-gray-500 cursor-pointer hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Unavailable</p>
                                <p class="text-2xl font-bold text-gray-700" th:text="${unavailableCount ?: 0}">0</p>
                                <p class="text-xs text-gray-500 mt-1">Không khả dụng</p>
                            </div>
                            <i class="fas fa-ban text-4xl text-gray-500 opacity-60"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plate</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                            <tr th:each="v : ${vehicles}" class="vehicle-row hover:bg-gray-50" th:data-status="${v.status.name()}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <img th:src="${v.mainImageUrl ?: 'https://via.placeholder.com/80x50?text=No+Image'}" class="w-20 h-12 object-cover rounded" th:alt="${v.vehicleModel ?: 'Vehicle'}"/>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800" th:text="${v.vehicleModel ?: 'N/A'}">Model</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" th:text="${v.licensePlate ?: 'N/A'}">Plate</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span th:class="'status-badge status-' + ${v.status.name()}" th:text="${v.status ?: 'Unknown'}"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                    <button class="text-indigo-600 hover:text-indigo-900" title="Edit" th:attr="onclick=|openEditCarModal('${v.vehicleId}')|">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-red-600 hover:text-red-900" title="Delete" th:attr="onclick=|deleteCar('${v.vehicleId}')|">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${vehicles == null or #lists.isEmpty(vehicles)}">
                                <td colspan="5" class="text-center py-10 text-gray-500">No vehicles found.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="add-car-modal" class="modal hidden">
                <div class="modal-overlay" onclick="closeModal('add-car-modal')"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="text-xl font-semibold text-gray-800">Add New Vehicle</h3>
                        <button onclick="closeModal('add-car-modal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form th:action="@{/owner/cars}" method="post" enctype="multipart/form-data" class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <input name="model" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transmission</label>
                                <select name="transmissionTypeId" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="" disabled selected>Select transmission</option>
                                    <option th:each="t : ${transmissions}" th:value="${t.transmissionTypeId}" th:text="${t.transmissionTypeName}"></option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select name="categoryId" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="" disabled selected>Select category</option>
                                    <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"></option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
                                <select name="type" id="vehicle-type-select" onchange="updateFeatures()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="ElectricCar">Electric Car</option>
                                    <option value="ElectricMotorcycle">Electric Motorcycle</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year Manufactured</label>
                                <input type="number" name="yearManufactured" min="2000" th:max="${#dates.year(#dates.createNow())}" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License Plate</label>
                                <input name="licensePlate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seats</label>
                                <input type="number" name="seats" value="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Odometer</label>
                                <input type="number" name="odometer" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate (VND)</label>
                                <input type="number" step="1000" name="hourlyRate" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Daily Rate (VND)</label>
                                <input type="number" step="1000" name="dailyRate" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Rate (VND)</label>
                                <input type="number" step="1000" name="monthlyRate" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Battery Capacity (kWh)</label>
                                <input type="number" step="0.01" name="batteryCapacity" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Features</label>
                                <div id="features-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                                <input type="hidden" name="features" id="selected-features" />
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Requires License</label>
                                <select name="requiresLicense" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="true" selected>Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Initial Status</label>
                                <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="Available" selected>Available</option>
                                    <option value="Unavailable">Unavailable</option>
                                    <option value="Maintenance">Maintenance</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                                <input type="file" name="images" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="closeModal('add-car-modal')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">Cancel</button>
                            <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent text-sm">Save Vehicle</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="edit-car-modal" class="modal hidden">
                <div class="modal-overlay" onclick="closeModal('edit-car-modal')"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="text-xl font-semibold text-gray-800">Edit Vehicle</h3>
                        <button onclick="closeModal('edit-car-modal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form id="edit-car-form" method="post" enctype="multipart/form-data" class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <input type="hidden" id="edit-vehicleId" name="vehicleId"/>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <input id="edit-model" name="model" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transmission</label>
                                <select id="edit-transmissionTypeId" name="transmissionTypeId" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option th:each="t : ${transmissions}" th:value="${t.transmissionTypeId}" th:text="${t.transmissionTypeName}"></option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select id="edit-categoryId" name="categoryId" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"></option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
                                <select id="edit-type" name="type" onchange="updateEditFeatures()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="ElectricCar">Electric Car</option>
                                    <option value="ElectricMotorcycle">Electric Motorcycle</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year Manufactured</label>
                                <input id="edit-yearManufactured" type="number" name="yearManufactured" min="2000" th:max="${#dates.year(#dates.createNow())}" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">License Plate</label>
                                <input id="edit-licensePlate" name="licensePlate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seats</label>
                                <input id="edit-seats" type="number" name="seats" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Odometer</label>
                                <input id="edit-odometer" type="number" name="odometer" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate (VND)</label>
                                <input id="edit-hourlyRate" type="number" step="1000" name="hourlyRate" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Daily Rate (VND)</label>
                                <input id="edit-dailyRate" type="number" step="1000" name="dailyRate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Rate (VND)</label>
                                <input id="edit-monthlyRate" type="number" step="1000" name="monthlyRate" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Battery Capacity (kWh)</label>
                                <input id="edit-batteryCapacity" type="number" step="0.01" name="batteryCapacity" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Features</label>
                                <div id="edit-features-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                                <input type="hidden" name="features" id="edit-selected-features" />
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="edit-description" name="description" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Requires License</label>
                                <select id="edit-requiresLicense" name="requiresLicense" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="edit-status" name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="Available">Available</option>
                                    <option value="Rented">Rented</option>
                                    <option value="Unavailable">Unavailable</option>
                                    <option value="Maintenance">Maintenance</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Image (Optional)</label>
                                <input type="file" name="images" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="closeModal('edit-car-modal')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">Cancel</button>
                            <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent text-sm">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>

<script th:src="@{/js/sidebar-common.js}"></script>
<script th:src="@{/js/owner-dashboard.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Highlight current page in sidebar
    document.addEventListener("DOMContentLoaded", function () {
        const currentPage = /*[[${currentPage}]]*/ "cars"; // Default to 'cars' if not set
        if (currentPage && typeof highlightOwnerSidebarLink === "function") {
            highlightOwnerSidebarLink(currentPage);
        } else {
            console.warn("Could not highlight sidebar for page:", currentPage);
        }
        // Initialize features for the Add modal (assuming it might be visible initially or toggled)
        updateFeatures();
    });

    // Modal toggle/close functions
    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.toggle("hidden");
            // Initialize features when 'add' modal opens
            if (modalId === 'add-car-modal' && !modal.classList.contains('hidden')) {
                updateFeatures(); // Render features based on default type
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add("hidden");
        }
    }

    // Open Edit Modal and fetch data
    async function openEditCarModal(id) {
        console.log("Editing car with ID:", id);
        try {
            const response = await fetch(`/owner/api/cars/${id}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Failed to fetch vehicle data. Status: ${response.status}`);
            }
            const vehicle = await response.json();

            // Populate form fields
            document.getElementById("edit-vehicleId").value = vehicle.vehicleId || "";
            document.getElementById("edit-model").value = vehicle.vehicleModel || "";
            document.getElementById("edit-transmissionTypeId").value = vehicle.transmission?.transmissionTypeId || ""; // Use optional chaining
            document.getElementById("edit-categoryId").value = vehicle.category?.categoryId || ""; // Use optional chaining
            document.getElementById("edit-type").value = vehicle.type || "ElectricCar";
            document.getElementById("edit-yearManufactured").value = vehicle.yearManufactured || "";
            document.getElementById("edit-licensePlate").value = vehicle.licensePlate || "";
            document.getElementById("edit-seats").value = vehicle.seats || "";
            document.getElementById("edit-odometer").value = vehicle.odometer || "0";
            document.getElementById("edit-hourlyRate").value = vehicle.hourlyRate || "0";
            document.getElementById("edit-dailyRate").value = vehicle.dailyRate || "0";
            document.getElementById("edit-monthlyRate").value = vehicle.monthlyRate || "0";
            document.getElementById("edit-batteryCapacity").value = vehicle.batteryCapacity || "";
            document.getElementById("edit-description").value = vehicle.description || "";
            document.getElementById("edit-requiresLicense").value = vehicle.requiresLicense ? "true" : "false";
            document.getElementById("edit-status").value = vehicle.status || "Available";

            // --- Feature Selection Integration ---
            // Initialize hidden input FIRST with existing data
            document.getElementById("edit-selected-features").value = JSON.stringify(vehicle.features || []);
            // THEN render checkboxes, which will read from the hidden input
            updateEditFeatures();
            // --- End Feature Selection Integration ---

            // Set form action URL
            const form = document.getElementById("edit-car-form");
            form.action = `/owner/cars/${id}`;

            // Show the modal
            toggleModal("edit-car-modal");
        } catch (error) {
            console.error("Error opening edit modal:", error);
            alert("Could not load vehicle data: " + error.message);
        }
    }

    // Delete Car function
    async function deleteCar(id) {
        if (!confirm("Are you sure you want to delete this vehicle?")) return;
        try {
            const headers = { "X-Requested-With": "XMLHttpRequest" };
            const csrfToken = /*[[${_csrf.token}]]*/ null;
            const csrfHeaderName = /*[[${_csrf.headerName}]]*/ null;
            if (csrfHeaderName && csrfToken) headers[csrfHeaderName] = csrfToken;

            const response = await fetch(`/owner/cars/${id}`, { method: "DELETE", headers: headers });
            const result = await response.json(); // Assume API always returns JSON

            if (result.status === "success") {
                alert(result.message || "Vehicle deleted successfully!");
                location.reload();
            } else {
                throw new Error(result.message || "Failed to delete vehicle.");
            }
        } catch (error) {
            console.error("Error deleting vehicle:", error);
            alert("Error: " + error.message);
        }
    }

    // --- Feature Selection Logic ---
    const vehicleFeatures = {
        ElectricCar: [
            "GPS Navigation",
            "Bluetooth Audio",
            "Air Conditioning",
            "Power Windows",
            "Central Locking",
            "USB Charging Ports",
            "Backup Camera",
            "Parking Sensors",
            "Cruise Control",
            "Keyless Entry",
            "Sunroof",
            "Leather Seats",
            "Heated Seats",
            "Automatic Transmission",
            "ABS Brakes",
            "Airbags",
            "LED Headlights",
            "Fog Lights",
            "Rain Sensing Wipers",
            "Auto Climate Control",
        ],
        ElectricMotorcycle: [
            "GPS Navigation",
            "Bluetooth Audio",
            "USB Charging Port",
            "LED Headlights",
            "Digital Display",
            "Anti-lock Braking System",
            "Keyless Start",
            "Storage Compartment",
            "Phone Mount",
            "Helmet Lock",
            "Side Stand",
            "Center Stand",
            "Windshield",
            "Rear View Mirrors",
            "Turn Signals",
            "Horn",
            "Speedometer",
            "Battery Indicator",
            "Range Indicator",
            "Eco Mode",
        ],
    };

    function renderFeatures(container, hiddenInput, vehicleType) {
        const features = vehicleFeatures[vehicleType] || [];
        container.innerHTML = ""; // Clear existing checkboxes
        const existingFeatures = hiddenInput.value ? JSON.parse(hiddenInput.value) : []; // Read existing features

        features.forEach(feature => {
            const featureId = `feature-${feature.replace(/\s+/g, "-").toLowerCase()}`;
            // Determine if this feature was already selected (based on hidden input)
            const isChecked = existingFeatures.includes(feature);

            const checkboxDiv = document.createElement("div");
            checkboxDiv.className = "flex items-center space-x-2";
            checkboxDiv.innerHTML = `
                <input type="checkbox"
                       id="${container.id}-${featureId}"
                       value="${feature}"
                       class="feature-checkbox rounded border-gray-300 text-primary focus:ring-primary"
                       onchange="updateSelectedFeatures('${container.id}', '${hiddenInput.id}')"
                       ${isChecked ? 'checked' : ''}>
                <label for="${container.id}-${featureId}"
                       class="text-sm text-gray-700 cursor-pointer">${feature}</label>
            `;
            container.appendChild(checkboxDiv);
        });
        // Call update immediately after rendering to ensure hidden input is correct initially
        updateSelectedFeatures(container.id, hiddenInput.id);
    }

    // Update Add Modal features based on type select
    function updateFeatures() {
        const vehicleType = document.getElementById("vehicle-type-select").value;
        const container = document.getElementById("features-container");
        const hiddenInput = document.getElementById("selected-features");
        // When type changes in ADD modal, clear existing hidden value before rendering
        hiddenInput.value = "[]";
        renderFeatures(container, hiddenInput, vehicleType);
    }

    // Update Edit Modal features based on type select
    function updateEditFeatures() {
        const vehicleType = document.getElementById("edit-type").value;
        const container = document.getElementById("edit-features-container");
        const hiddenInput = document.getElementById("edit-selected-features");
        // When type changes in EDIT modal, re-render based on current hidden input value
        renderFeatures(container, hiddenInput, vehicleType);
    }

    // Update the hidden input with selected features as JSON string
    function updateSelectedFeatures(containerId, hiddenInputId) {
        const container = document.getElementById(containerId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const checkboxes = container.querySelectorAll(".feature-checkbox:checked");
        const selectedFeatures = Array.from(checkboxes).map(cb => cb.value);
        hiddenInput.value = JSON.stringify(selectedFeatures);
        console.log("Updated hidden input:", hiddenInputId, hiddenInput.value); // Debug log
    }
    // --- End Feature Selection Logic ---

    // Filter table rows by status
    function quickFilterStatus(status) {
        const rows = document.querySelectorAll(".vehicle-row");
        let found = false;
        rows.forEach(row => {
            const rowStatus = row.getAttribute("data-status");
            if (rowStatus === status) {
                row.style.display = ""; // Show matching rows
                found = true;
            } else {
                row.style.display = "none"; // Hide non-matching rows
            }
        });
        // Show/hide empty state row if needed
        const emptyRow = document.querySelector('tbody tr td[colspan="5"]'); // Updated colspan
        if (emptyRow && emptyRow.parentNode) { // Check parentNode existence
            emptyRow.parentNode.style.display = found ? 'none' : '';
        }
    }

    // Reset filter - show all rows
    function showAllVehicles() {
        const rows = document.querySelectorAll(".vehicle-row");
        let hasRows = rows.length > 0;
        rows.forEach(row => {
            row.style.display = "";
        });
        const emptyRow = document.querySelector('tbody tr td[colspan="5"]'); // Updated colspan
        if (emptyRow && emptyRow.parentNode) { // Check parentNode existence
            emptyRow.parentNode.style.display = hasRows ? 'none' : '';
        }
    }
    /*]]>*/
</script>

</body>
</html>