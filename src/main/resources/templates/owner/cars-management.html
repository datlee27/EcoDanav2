<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body>
<style>
    .primary { color: #4CAF50; }
    .bg-primary { background-color: #4CAF50; }
    .hidden { display: none; }
</style>
<div th:replace="~{fragments/nav :: nav}"></div>
<div th:replace="~{owner/owner-sidebar :: sidebar}"></div>

<div class="ml-64 mt-16">
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Car Management</h1>
                    <p class="text-gray-600">Manage your vehicles</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800" th:text="${currentUser?.firstName + ' ' + currentUser?.lastName ?: 'Owner'}">Owner</p>
                        <p class="text-sm text-gray-600">Car Owner</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Car Management Content -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">My Cars</h2>
            <button onclick="toggleModal('add-car-modal')" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i>Add New Car
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Image</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Model</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Plate</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                <tr th:each="v : ${vehicles}">
                    <td class="px-6 py-4">
                        <img th:src="${v.mainImageUrl ?: 'https://via.placeholder.com/80x50?text=No+Image'}" class="w-20 h-12 object-cover rounded" th:alt="${v.vehicleModel ?: 'Vehicle'}"/>
                    </td>
                    <td class="px-6 py-4" th:text="${v.vehicleModel ?: 'N/A'}">Model</td>
                    <td class="px-6 py-4" th:text="${v.licensePlate ?: 'N/A'}">Plate</td>
                    <td class="px-6 py-4">
                         <span th:class="'px-3 py-1 rounded-full text-xs font-medium status-' + ${#strings.toLowerCase(v.status.name())}" th:text="${v.status ?: 'Unknown'}"></span>
                    </td>
                    <td class="px-6 py-4 space-x-2">
                        <button class="px-3 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200" th:attr="onclick=|openEditCarModal('${v.vehicleId}')|">
                            Edit
                        </button>
                        <button class="px-3 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200" th:attr="onclick=|deleteCar('${v.vehicleId}')|">
                            Delete
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Add Car Modal -->
        <div id="add-car-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-2">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">Add New Vehicle</h3>
                    <button onclick="toggleModal('add-car-modal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form th:action="@{/owner/cars}" method="post" enctype="multipart/form-data" class="overflow-y-auto">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Form fields -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                            <input name="model" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transmission</label>
                            <select name="transmissionTypeId" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>Select transmission</option>
                                <option th:each="t : ${transmissions}" th:value="${t.transmissionTypeId}" th:text="${t.transmissionTypeName}"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select name="categoryId" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>Select category</option>
                                <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
                            <select name="type" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="ElectricCar">Electric Car</option>
                                <option value="ElectricMotorcycle">Electric Motorcycle</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Year Manufactured</label>
                            <input type="number" name="yearManufactured" min="2000" th:max="${#dates.year(#dates.createNow())}" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">License Plate</label>
                            <input name="licensePlate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seats</label>
                            <input type="number" name="seats" value="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Odometer</label>
                            <input type="number" name="odometer" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate ($)</label>
                            <input type="number" step="0.01" name="hourlyRate" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Rate ($)</label>
                            <input type="number" step="0.01" name="dailyRate" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Rate ($)</label>
                            <input type="number" step="0.01" name="monthlyRate" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Battery Capacity (kWh)</label>
                            <input type="number" step="0.01" name="batteryCapacity" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea name="description" class="w-full px-4 py-3 border border-gray-300 rounded-lg" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Requires License</label>
                            <select name="requiresLicense" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="true" selected>Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Initial Status</label>
                            <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="Available" selected>Available</option>
                                <option value="Unavailable">Unavailable</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                            <input type="file" name="images" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 border-t">
                        <button type="button" onclick="toggleModal('add-car-modal')" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">Cancel</button>
                        <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600">Save Vehicle</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Car Modal -->
        <div id="edit-car-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-2">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">Edit Vehicle</h3>
                    <button onclick="toggleModal('edit-car-modal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <form id="edit-car-form" method="post" enctype="multipart/form-data" class="overflow-y-auto">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="hidden" id="edit-vehicleId" name="vehicleId">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                            <input id="edit-model" name="model" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transmission</label>
                            <select id="edit-transmissionTypeId" name="transmissionTypeId" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option th:each="t : ${transmissions}" th:value="${t.transmissionTypeId}" th:text="${t.transmissionTypeName}"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select id="edit-categoryId" name="categoryId" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
                            <select id="edit-type" name="type" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="ElectricCar">Electric Car</option>
                                <option value="ElectricMotorcycle">Electric Motorcycle</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Year Manufactured</label>
                            <input id="edit-yearManufactured" type="number" name="yearManufactured" min="2000" th:max="${#dates.year(#dates.createNow())}" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">License Plate</label>
                            <input id="edit-licensePlate" name="licensePlate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seats</label>
                            <input id="edit-seats" type="number" name="seats" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Odometer</label>
                            <input id="edit-odometer" type="number" name="odometer" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hourly Rate ($)</label>
                            <input id="edit-hourlyRate" type="number" step="0.01" name="hourlyRate" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Rate ($)</label>
                            <input id="edit-dailyRate" type="number" step="0.01" name="dailyRate" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Rate ($)</label>
                            <input id="edit-monthlyRate" type="number" step="0.01" name="monthlyRate" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Battery Capacity (kWh)</label>
                            <input id="edit-batteryCapacity" type="number" step="0.01" name="batteryCapacity" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="edit-description" name="description" class="w-full px-4 py-3 border border-gray-300 rounded-lg" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Requires License</label>
                            <select id="edit-requiresLicense" name="requiresLicense" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="edit-status" name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="Available">Available</option>
                                <option value="Unavailable">Unavailable</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Image (Optional)</label>
                            <input type="file" name="images" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 px-6 py-4 bg-gray-50 border-t">
                        <button type="button" onclick="toggleModal('edit-car-modal')" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">Cancel</button>
                        <button type="submit" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = /*[[${_csrf.token}]]*/ null;
    const csrfHeaderName = /*[[${_csrf.headerName}]]*/ null;

    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.toggle('hidden');
        }
    }

    async function openEditCarModal(id) {
        console.log("Editing car with ID:", id);
        try {
            const response = await fetch(`/owner/api/cars/${id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch vehicle data.');
            }
            const vehicle = await response.json();

            // Populate form
            document.getElementById('edit-vehicleId').value = vehicle.vehicleId;
            document.getElementById('edit-model').value = vehicle.vehicleModel;
            document.getElementById('edit-transmissionTypeId').value = vehicle.transmission.transmissionTypeId;
            document.getElementById('edit-categoryId').value = vehicle.category.categoryId;
            document.getElementById('edit-type').value = vehicle.type;
            document.getElementById('edit-yearManufactured').value = vehicle.yearManufactured;
            document.getElementById('edit-licensePlate').value = vehicle.licensePlate;
            document.getElementById('edit-seats').value = vehicle.seats;
            document.getElementById('edit-odometer').value = vehicle.odometer;
            document.getElementById('edit-hourlyRate').value = vehicle.hourlyRate;
            document.getElementById('edit-dailyRate').value = vehicle.dailyRate;
            document.getElementById('edit-monthlyRate').value = vehicle.monthlyRate;
            document.getElementById('edit-batteryCapacity').value = vehicle.batteryCapacity;
            document.getElementById('edit-description').value = vehicle.description;
            document.getElementById('edit-requiresLicense').value = vehicle.requiresLicense;
            document.getElementById('edit-status').value = vehicle.status;

            // Set form action
            const form = document.getElementById('edit-car-form');
            form.action = `/owner/cars/${id}`;

            toggleModal('edit-car-modal');
        } catch (error) {
            console.error("Error opening edit modal:", error);
            alert("Could not load vehicle data. Please try again.");
        }
    }

    async function deleteCar(id) {
        if (!confirm('Are you sure you want to delete this vehicle?')) {
            return;
        }
        try {
            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfHeaderName && csrfToken) {
                headers[csrfHeaderName] = csrfToken;
            }

            const response = await fetch(`/owner/cars/${id}`, {
                method: 'DELETE',
                headers: headers
            });

            const result = await response.json();
            if (response.ok && result.status === 'success') {
                alert('Vehicle deleted successfully!');
                location.reload();
            } else {
                throw new Error(result.message || 'Failed to delete vehicle.');
            }
        } catch (error) {
            console.error('Error deleting vehicle:', error);
            alert('Error: ' + error.message);
        }
    }

    function toggleVehicleStatus(checkbox) {
        const id = checkbox.getAttribute("data-id");
        const headers = {};
        if (csrfHeaderName && csrfToken) {
            headers[csrfHeaderName] = csrfToken;
        }

        fetch(`/owner/cars/${id}/toggle-availability`, { method: "POST", headers: headers })
        .then(() => location.reload())
        .catch((err) => {
            alert("Failed to update status");
            checkbox.checked = !checkbox.checked;
        });
    }
    /*]]>*/
</script>

</body>
</html>
