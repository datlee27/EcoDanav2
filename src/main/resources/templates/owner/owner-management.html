<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head}"></head>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/owner-management.css}" />
  </head>
  <body>
    <div th:replace="~{fragments/nav :: nav}"></div>

    <!-- Success/Error Notifications -->
    <div
      th:if="${success}"
      id="success-notification"
      class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300"
    >
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-3"></i>
          <span th:text="${success}">Success!</span>
        </div>
        <button onclick="closeNotification(this)" class="ml-4 text-white hover:text-gray-200 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div
      th:if="${error}"
      id="error-notification"
      class="fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300"
    >
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-3"></i>
          <span th:text="${error}">Error!</span>
        </div>
        <button onclick="closeNotification(this)" class="ml-4 text-white hover:text-gray-200 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Booking Management</h1>
            <p class="text-gray-600">Manage your bookings and rental calendar</p>
          </div>
          <div class="flex items-center space-x-4">
            <button class="relative p-2 text-gray-600 hover:text-primary">
              <i class="fas fa-bell text-xl"></i>
              <span
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                th:text="${pendingBookings?.size() ?: 0}"
                >0</span
              >
            </button>
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                <i class="fas fa-user text-white text-lg"></i>
              </div>
              <div>
                <p
                  class="font-semibold text-gray-800"
                  th:text="${currentUser?.firstName + ' ' + currentUser?.lastName ?: 'Owner'}"
                >
                  Owner
                </p>
                <p class="text-sm text-gray-600">Car Owner</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-6">
      <!-- Tab Navigation -->
      <div class="flex space-x-4 mb-6 border-b">
        <button
          onclick="switchTab('bookings')"
          id="bookings-tab"
          class="tab-button active px-6 py-3 font-semibold border-b-2 border-primary text-primary transition-colors"
        >
          <i class="fas fa-list mr-2"></i>Booking Management
        </button>
        <button
          onclick="switchTab('calendar')"
          id="calendar-tab"
          class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent text-gray-600 hover:text-primary transition-colors"
        >
          <i class="fas fa-calendar-alt mr-2"></i>Calendar View
        </button>
      </div>

      <!-- Bookings Management Section -->
      <div id="bookings-section" class="tab-content">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-600 text-sm">Pending</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${pendingCount ?: 0}">0</p>
              </div>
              <i class="fas fa-clock text-3xl text-yellow-500"></i>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-600 text-sm">Approved</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${approvedCount ?: 0}">0</p>
              </div>
              <i class="fas fa-check-circle text-3xl text-green-500"></i>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-600 text-sm">Ongoing</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${ongoingCount ?: 0}">0</p>
              </div>
              <i class="fas fa-car text-3xl text-blue-500"></i>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-gray-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-600 text-sm">Completed</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${completedCount ?: 0}">0</p>
              </div>
              <i class="fas fa-flag-checkered text-3xl text-gray-500"></i>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Status Filter</label>
              <select
                id="status-filter"
                onchange="filterBookings()"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              >
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Ongoing">Ongoing</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
              <input
                type="text"
                id="search-input"
                onkeyup="filterBookings()"
                placeholder="Search by code or customer..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
              <select
                id="sort-select"
                onchange="filterBookings()"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              >
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="amount-high">Amount: High to Low</option>
                <option value="amount-low">Amount: Low to High</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Bookings Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Booking Code
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Customer
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Vehicle
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Pickup Date
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Return Date
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="bookings-table-body">
                <tr
                  th:each="booking : ${bookings}"
                  class="booking-row hover:bg-gray-50 transition-colors"
                  th:data-status="${booking.status}"
                  th:data-code="${booking.bookingCode}"
                  th:data-customer="${booking.user?.firstName + ' ' + booking.user?.lastName}"
                  th:data-created="${booking.createdDate}"
                  th:data-amount="${booking.totalAmount}"
                >
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="font-semibold text-primary" th:text="${booking.bookingCode}">BK001</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-2">
                        <i class="fas fa-user text-gray-600 text-xs"></i>
                      </div>
                      <div>
                        <p
                          class="font-medium text-gray-800"
                          th:text="${booking.user?.firstName + ' ' + booking.user?.lastName}"
                        >
                          Customer Name
                        </p>
                        <p class="text-xs text-gray-500" th:text="${booking.user?.email}">email@example.com</p>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <p class="font-medium text-gray-800" th:text="${booking.vehicle?.vehicleModel}">Vehicle Model</p>
                    <p class="text-xs text-gray-500" th:text="${booking.vehicle?.licensePlate}">License Plate</p>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span th:text="${#temporals.format(booking.pickupDateTime, 'dd/MM/yyyy HH:mm')}"
                      >01/01/2024 10:00</span
                    >
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span th:text="${#temporals.format(booking.returnDateTime, 'dd/MM/yyyy HH:mm')}"
                      >05/01/2024 10:00</span
                    >
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      class="font-semibold text-gray-800"
                      th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT') + ' VND'}"
                      >1,000,000 VND</span
                    >
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      class="status-badge"
                      th:classappend="${'status-' + #strings.toLowerCase(booking.status)}"
                      th:text="${booking.status}"
                      >Pending</span
                    >
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button
                      onclick="viewBookingDetail(this)"
                      th:data-booking-id="${booking.bookingId}"
                      class="text-blue-600 hover:text-blue-800 mr-2"
                      title="View Details"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                    <button
                      th:if="${booking.status.name() == 'Pending'}"
                      onclick="approveBooking(this)"
                      th:data-booking-id="${booking.bookingId}"
                      class="text-green-600 hover:text-green-800 mr-2"
                      title="Approve"
                    >
                      <i class="fas fa-check"></i>
                    </button>
                    <button
                      th:if="${booking.status.name() == 'Pending'}"
                      onclick="rejectBooking(this)"
                      th:data-booking-id="${booking.bookingId}"
                      class="text-red-600 hover:text-red-800"
                      title="Reject"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(bookings)}">
                  <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <p>No bookings found</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Calendar Section (Timeline View) -->
      <div id="calendar-section" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <!-- Simple Header -->
          <div class="flex justify-between items-center mb-6 pb-4 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Booking Timeline</h3>
            <div class="flex items-center space-x-3">
              <select
                id="group-by-select"
                onchange="changeGrouping(this.value)"
                class="px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary"
              >
                <option value="day">By Day</option>
                <option value="month" selected>By Month</option>
                <option value="year">By Year</option>
              </select>
            </div>
          </div>

          <!-- Timeline Table -->
          <div id="timeline-container">
            <!-- Content will be dynamically generated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Booking Detail Modal -->
    <div id="booking-detail-modal" class="modal hidden">
      <div class="modal-overlay" onclick="closeModal('booking-detail-modal')"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-2xl font-bold text-gray-800">Booking Details</h3>
          <button onclick="closeModal('booking-detail-modal')" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-body" id="booking-detail-content">
          <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
            <p class="mt-2 text-gray-600">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Profile Modal -->
    <div id="customer-profile-modal" class="modal hidden">
      <div class="modal-overlay" onclick="closeModal('customer-profile-modal')"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-2xl font-bold text-gray-800">Customer Profile</h3>
          <button onclick="closeModal('customer-profile-modal')" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-body" id="customer-profile-content">
          <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
            <p class="mt-2 text-gray-600">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Approve Confirmation Modal -->
    <div id="approve-modal" class="modal hidden">
      <div class="modal-overlay" onclick="closeModal('approve-modal')"></div>
      <div class="modal-content max-w-md">
        <div class="modal-header">
          <h3 class="text-xl font-bold text-gray-800">Approve Booking</h3>
          <button onclick="closeModal('approve-modal')" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-body">
          <p class="text-gray-700 mb-4">
            Are you sure you want to approve this booking? The vehicle will be marked as unavailable for the rental
            period.
          </p>
          <div class="flex justify-end space-x-3">
            <button
              onclick="closeModal('approve-modal')"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
            <button onclick="confirmApprove()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
              <i class="fas fa-check mr-2"></i>Approve
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reject Confirmation Modal -->
    <div id="reject-modal" class="modal hidden">
      <div class="modal-overlay" onclick="closeModal('reject-modal')"></div>
      <div class="modal-content max-w-md">
        <div class="modal-header">
          <h3 class="text-xl font-bold text-gray-800">Reject Booking</h3>
          <button onclick="closeModal('reject-modal')" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="modal-body">
          <p class="text-gray-700 mb-4">Please provide a reason for rejecting this booking:</p>
          <textarea
            id="reject-reason"
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
            placeholder="Enter rejection reason..."
          ></textarea>
          <div class="flex justify-end space-x-3 mt-4">
            <button
              onclick="closeModal('reject-modal')"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
            <button onclick="confirmReject()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
              <i class="fas fa-times mr-2"></i>Reject
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:src="@{/js/owner-management.js}"></script>
    <script th:inline="javascript">
      // Pass server data to JavaScript
      var contextPath = /*[[@{/}]]*/ "";
      var csrfToken = /*[[${_csrf.token}]]*/ "";
      var csrfHeader = /*[[${_csrf.headerName}]]*/ "";
    </script>

    <style>
      .primary {
        color: #4caf50;
      }
      .bg-primary {
        background-color: #4caf50;
      }

      .tab-button.active {
        color: #4caf50;
        border-color: #4caf50;
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }
      .status-approved {
        background-color: #d1fae5;
        color: #065f46;
      }
      .status-rejected {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .status-ongoing {
        background-color: #dbeafe;
        color: #1e40af;
      }
      .status-completed {
        background-color: #e5e7eb;
        color: #374151;
      }
      .status-cancelled {
        background-color: #f3f4f6;
        color: #6b7280;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal.hidden {
        display: none;
      }

      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        position: relative;
        background-color: white;
        border-radius: 0.5rem;
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
      }
    </style>

    <div th:replace="~{fragments/footer :: footer}"></div>
  </body>
</html>
