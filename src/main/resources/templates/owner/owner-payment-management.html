<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="payments-content">
    <!-- Status Tabs -->
    <div class="status-tab-container" id="status-tabs">
        <button class="status-tab active" data-status="" onclick="changeStatusTab(this)">
            Tất cả <span class="count-badge" th:text="${countAll ?: 0}">0</span>
        </button>
        <button class="status-tab" data-status="Completed" onclick="changeStatusTab(this)">
            Hoàn Thành <span class="count-badge" th:text="${countCompleted ?: 0}">0</span>
        </button>
        <button class="status-tab" data-status="Refunded,Failed" onclick="changeStatusTab(this)">
            Hoàn Tiền <span class="count-badge" th:text="${countRefunded ?: 0}">0</span>
        </button>
        <button class="status-tab" data-status="Cancelled" onclick="changeStatusTab(this)">
            Đã Hủy <span class="count-badge" th:text="${countCancelled ?: 0}">0</span>
        </button>
    </div>

    <!-- Statistic Panels -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
            <div class="bg-green-100 p-3 rounded-full">
                <i class="fas fa-chart-line text-2xl text-green-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500">Tổng doanh thu</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' ₫'">150.000.000 ₫</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
            <div class="bg-blue-100 p-3 rounded-full">
                <i class="fas fa-wallet text-2xl text-blue-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500">Tiền thực nhận</p>
                <p class="text-2xl font-bold text-gray-800" th:text="${#numbers.formatDecimal(netRevenue, 0, 'COMMA', 0, 'POINT')} + ' ₫'">145.000.000 ₫</p>
            </div>
        </div>
    </div>

    <!-- Filter and Sort -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm thông tin</label>
                <input type="text" id="search-input" onkeyup="filterAndSortPayments()" placeholder="Tìm theo mã đơn, khách hàng, mẫu xe..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm"/>
            </div>
            <div>
                <label for="sort-select" class="block text-sm font-medium text-gray-700 mb-1">Sắp xếp theo</label>
                <select id="sort-select" onchange="filterAndSortPayments()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                    <option value="amount-high">Số tiền: Cao đến thấp</option>
                    <option value="amount-low">Số tiền: Thấp đến cao</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã đơn</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vị trí nhận xe</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian thuê</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số tiền</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày tạo</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="payment-list-body">
                <tr th:each="payment : ${payments}"
                    class="hover:bg-gray-50"
                    th:attr="data-status=${payment.paymentStatus.name()},
                             data-created-date=${payment.createdDate},
                             data-amount=${payment.amount}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${payment.booking?.bookingCode}"></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900" th:text="${payment.booking?.user?.firstName + ' ' + payment.booking?.user?.lastName}"></div>
                            <div class="text-sm text-gray-500">
                                <span th:text="${payment.booking?.vehicle?.vehicleModel}"></span>
                                <br>
                                <span th:text="${payment.booking?.vehicle?.licensePlate}"></span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" th:text="${payment.booking?.pickupLocation}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        <span th:text="${#temporals.format(payment.booking?.pickupDateTime, 'dd/MM/yy HH:mm')}"></span>
                        <br>
                        <span th:text="${#temporals.format(payment.booking?.returnDateTime, 'dd/MM/yy HH:mm')}"></span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span th:switch="${payment.paymentStatus.name()}"
                              th:classappend="${payment.paymentStatus.name() == 'Completed' ? 'bg-green-100 text-green-800' :
                                               (payment.paymentStatus.name() == 'Refunded' or payment.paymentStatus.name() == 'Failed' ? 'bg-yellow-100 text-yellow-800' :
                                               (payment.paymentStatus.name() == 'Cancelled' ? 'bg-red-100 text-red-800' : ''))}"
                              class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            <span th:case="'Completed'">Hoàn Thành</span>
                            <span th:case="*{(payment.paymentStatus.name() == 'Refunded' or payment.paymentStatus.name() == 'Failed')}">Hoàn Tiền</span>
                            <span th:case="*">Đã Hủy</span>
                            <span th:case="*">N/A</span>
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800" th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" th:text="${#temporals.format(payment.createdDate, 'dd/MM/yyyy HH:mm')}"></td>
                </tr>
                <tr th:if="${payments == null or #lists.isEmpty(payments)}">
                    <td colspan="7" class="text-center py-12">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-file-invoice-dollar text-6xl text-gray-300 mb-4"></i>
                            <p class="text-lg">Không có dữ liệu thanh toán.</p>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script th:inline="javascript">
let paymentRows = [];
let noDataRow;

document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('payment-list-body');
    // Lấy tất cả các dòng có dữ liệu
    paymentRows = Array.from(tableBody.querySelectorAll('tr[data-status]'));
    // Lấy dòng thông báo "Không có dữ liệu"
    noDataRow = tableBody.querySelector('tr:not([data-status])');

    // Kích hoạt bộ lọc lần đầu khi tải trang
    filterAndSortPayments();
});

function changeStatusTab(element) {
    // Bỏ class 'active' khỏi tất cả các tab
    document.querySelectorAll('#status-tabs .status-tab').forEach(tab => tab.classList.remove('active'));
    // Thêm class 'active' cho tab được click
    element.classList.add('active');
    // Chạy lại bộ lọc
    filterAndSortPayments();
}

function filterAndSortPayments() {
    // 1. Lấy các giá trị điều khiển
    const activeStatusFilter = document.querySelector('.status-tab.active').getAttribute('data-status');
    const statusArray = activeStatusFilter.split(','); // Xử lý trường hợp có nhiều status trong 1 tab
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const sortValue = document.getElementById('sort-select').value;
    const tableBody = document.getElementById('payment-list-body');

    let visibleRowCount = 0;
    let rowsToShow = [];

    // 2. Lọc và quyết định dòng nào được hiển thị
    paymentRows.forEach(row => {
        const rowStatus = row.getAttribute('data-status');
        const rowText = row.textContent.toLowerCase();

        // Điều kiện lọc: Trạng thái phải khớp VÀ nội dung phải khớp với từ khóa tìm kiếm
        const statusMatch = activeStatusFilter === '' || statusArray.includes(rowStatus);
        const searchMatch = searchTerm === '' || rowText.includes(searchTerm);

        if (statusMatch && searchMatch) {
            row.style.display = ''; // Hiển thị dòng
            rowsToShow.push(row);
            visibleRowCount++;
        } else {
            row.style.display = 'none'; // Ẩn dòng
        }
    });

    // 3. Sắp xếp các dòng sẽ được hiển thị
    rowsToShow.sort((a, b) => {
        const dateA = new Date(a.dataset.createdDate);
        const dateB = new Date(b.dataset.createdDate);
        const amountA = parseFloat(a.dataset.amount);
        const amountB = parseFloat(b.dataset.amount);

        switch (sortValue) {
            case 'oldest': return dateA - dateB;
            case 'amount-high': return amountB - amountA;
            case 'amount-low': return amountA - amountB;
            case 'newest':
            default: return dateB - dateA;
        }
    });

    // 4. Cập nhật lại DOM theo thứ tự đã sắp xếp
    rowsToShow.forEach(row => tableBody.appendChild(row));

    // 5. Hiển thị/ẩn thông báo "Không có dữ liệu"
    if (noDataRow) {
        noDataRow.style.display = visibleRowCount === 0 ? '' : 'none';
    }
}
</script>
</html>